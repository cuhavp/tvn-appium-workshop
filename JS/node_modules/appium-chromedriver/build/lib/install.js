"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.install = install;
exports.installAll = installAll;
exports.conditionalInstall = conditionalInstall;
exports.doInstall = doInstall;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _chromedriver = require("./chromedriver");

var _utils = require("./utils");

var _fancyLog = _interopRequireDefault(require("fancy-log"));

function log(line) {
  (0, _fancyLog.default)(`[Chromedriver Install] ${line}`);
}

const CD_CDN = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || 'https://chromedriver.storage.googleapis.com';
const CD_PLATS = ['linux', 'win', 'mac'];
const CD_ARCHS = ['32', '64'];

function getArchAndPlatform() {
  return _getArchAndPlatform.apply(this, arguments);
}

function _getArchAndPlatform() {
  _getArchAndPlatform = (0, _asyncToGenerator2.default)(function* () {
    let arch = yield _appiumSupport.system.arch();
    let platform = (0, _utils.getCurPlatform)();

    if (platform !== 'linux' && platform !== 'mac' && arch === '64') {
      arch = '32';
    }

    if (platform === 'mac' && parseFloat(_chromedriver.CD_VER) < 2.23) {
      arch = '32';
    }

    return {
      arch,
      platform
    };
  });
  return _getArchAndPlatform.apply(this, arguments);
}

function getDownloadUrl(version, platform, arch) {
  return `${CD_CDN}/${version}/chromedriver_${platform}${arch}.zip`;
}

function validatePlatform(platform, arch) {
  if (!_lodash.default.includes(CD_PLATS, platform)) {
    throw new Error(`Invalid platform: ${platform}`);
  }

  if (!_lodash.default.includes(CD_ARCHS, arch)) {
    throw new Error(`Invalid arch: ${arch}`);
  }

  if (arch === "64" && platform !== "linux" && platform !== 'mac') {
    throw new Error('Only linux has a 64-bit version of Chromedriver');
  }
}

function installForPlatform(_x, _x2, _x3) {
  return _installForPlatform.apply(this, arguments);
}

function _installForPlatform() {
  _installForPlatform = (0, _asyncToGenerator2.default)(function* (version, platform, arch) {
    if (version === 'LATEST') {
      version = (yield _requestPromise.default.get({
        uri: `${CD_CDN}/LATEST_RELEASE`
      })).trim();
    }

    validatePlatform(platform, arch);
    const url = getDownloadUrl(version, platform, arch);
    log(`Installing Chromedriver version '${version}' for platform '${platform}' and architecture '${arch}'`);
    const binarySpec = `chromedriver_${platform}${arch}`;
    log(`Opening temp file to write '${binarySpec}' to...`);
    const tempFile = yield _appiumSupport.tempDir.open({
      prefix: binarySpec,
      suffix: '.zip'
    });
    log(`Opened temp file '${tempFile.path}'`);
    log(`Downloading ${url}...`);
    const body = yield _requestPromise.default.get({
      url,
      encoding: 'binary'
    });
    log(`Writing binary content to ${tempFile.path}...`);
    yield _appiumSupport.fs.writeFile(tempFile.path, body, {
      encoding: 'binary'
    });
    yield _appiumSupport.fs.chmod(tempFile.path, 0o0644);

    const tempUnzipped = _path.default.resolve(_path.default.dirname(tempFile.path), binarySpec);

    log(`Extracting ${tempFile.path} to ${tempUnzipped}`);
    yield (0, _appiumSupport.mkdirp)(tempUnzipped);
    yield _appiumSupport.zip.extractAllTo(tempFile.path, tempUnzipped);

    let extractedBin = _path.default.resolve(tempUnzipped, 'chromedriver');

    if (platform === "win") {
      extractedBin += ".exe";
    }

    log(`Creating ${_path.default.resolve(_utils.CD_BASE_DIR, platform)}...`);
    yield (0, _appiumSupport.mkdirp)(_path.default.resolve(_utils.CD_BASE_DIR, platform));
    const newBin = yield (0, _utils.getChromedriverBinaryPath)(platform, arch);
    log(`Copying unzipped binary, reading from ${extractedBin}...`);
    const binContents = yield _appiumSupport.fs.readFile(extractedBin, {
      encoding: 'binary'
    });
    log(`Writing to ${newBin}...`);
    yield _appiumSupport.fs.writeFile(newBin, binContents, {
      encoding: 'binary',
      mode: 0o755
    });
    log(`${newBin} successfully put in place`);
  });
  return _installForPlatform.apply(this, arguments);
}

function install() {
  return _install.apply(this, arguments);
}

function _install() {
  _install = (0, _asyncToGenerator2.default)(function* () {
    const _ref = yield getArchAndPlatform(),
          arch = _ref.arch,
          platform = _ref.platform;

    yield installForPlatform(_chromedriver.CD_VER, platform, arch);
  });
  return _install.apply(this, arguments);
}

function conditionalInstall() {
  return _conditionalInstall.apply(this, arguments);
}

function _conditionalInstall() {
  _conditionalInstall = (0, _asyncToGenerator2.default)(function* () {
    const _ref2 = yield getArchAndPlatform(),
          arch = _ref2.arch,
          platform = _ref2.platform;

    const binPath = yield (0, _utils.getChromedriverBinaryPath)(platform, arch);

    if (!(yield _appiumSupport.fs.exists(binPath))) {
      yield installForPlatform(_chromedriver.CD_VER, platform, arch);
    } else {
      log(`No need to install chromedriver, ${binPath} exists`);
    }
  });
  return _conditionalInstall.apply(this, arguments);
}

function installAll() {
  return _installAll.apply(this, arguments);
}

function _installAll() {
  _installAll = (0, _asyncToGenerator2.default)(function* () {
    let downloads = [];
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = (0, _utils.getPlatforms)()[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        let _step$value = (0, _slicedToArray2.default)(_step.value, 2),
            platform = _step$value[0],
            arch = _step$value[1];

        downloads.push(installForPlatform(_chromedriver.CD_VER, platform, arch));
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return != null) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    yield (0, _asyncbox.parallel)(downloads);
  });
  return _installAll.apply(this, arguments);
}

function doInstall() {
  return _doInstall.apply(this, arguments);
}

function _doInstall() {
  _doInstall = (0, _asyncToGenerator2.default)(function* () {
    if (_lodash.default.includes(process.argv, '--all') || process.env.npm_config_chromedriver_install_all) {
      yield installAll();
    } else if (_lodash.default.includes(process.argv, '--conditional')) {
      yield conditionalInstall();
    } else {
      yield install();
    }
  });
  return _doInstall.apply(this, arguments);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsLmpzIl0sIm5hbWVzIjpbImxvZyIsImxpbmUiLCJDRF9DRE4iLCJwcm9jZXNzIiwiZW52IiwibnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfY2RudXJsIiwiQ0hST01FRFJJVkVSX0NETlVSTCIsIkNEX1BMQVRTIiwiQ0RfQVJDSFMiLCJnZXRBcmNoQW5kUGxhdGZvcm0iLCJhcmNoIiwic3lzdGVtIiwicGxhdGZvcm0iLCJwYXJzZUZsb2F0IiwiQ0RfVkVSIiwiZ2V0RG93bmxvYWRVcmwiLCJ2ZXJzaW9uIiwidmFsaWRhdGVQbGF0Zm9ybSIsIl8iLCJpbmNsdWRlcyIsIkVycm9yIiwiaW5zdGFsbEZvclBsYXRmb3JtIiwicmVxdWVzdCIsImdldCIsInVyaSIsInRyaW0iLCJ1cmwiLCJiaW5hcnlTcGVjIiwidGVtcEZpbGUiLCJ0ZW1wRGlyIiwib3BlbiIsInByZWZpeCIsInN1ZmZpeCIsInBhdGgiLCJib2R5IiwiZW5jb2RpbmciLCJmcyIsIndyaXRlRmlsZSIsImNobW9kIiwidGVtcFVuemlwcGVkIiwicmVzb2x2ZSIsImRpcm5hbWUiLCJ6aXAiLCJleHRyYWN0QWxsVG8iLCJleHRyYWN0ZWRCaW4iLCJDRF9CQVNFX0RJUiIsIm5ld0JpbiIsImJpbkNvbnRlbnRzIiwicmVhZEZpbGUiLCJtb2RlIiwiaW5zdGFsbCIsImNvbmRpdGlvbmFsSW5zdGFsbCIsImJpblBhdGgiLCJleGlzdHMiLCJpbnN0YWxsQWxsIiwiZG93bmxvYWRzIiwicHVzaCIsImRvSW5zdGFsbCIsImFyZ3YiLCJucG1fY29uZmlnX2Nocm9tZWRyaXZlcl9pbnN0YWxsX2FsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBOztBQUdBLFNBQVNBLEdBQVQsQ0FBY0MsSUFBZCxFQUFvQjtBQUNsQix5QkFBUSwwQkFBeUJBLElBQUssRUFBdEM7QUFDRDs7QUFFRCxNQUFNQyxNQUFNLEdB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QUcsQ0FBRSxvQ0FBbUNvRCxPQUFRLFNBQTdDLENBQUg7QUFDRDtBQUNGLEc7Ozs7U0FFY0UsVTs7Ozs7Z0RBQWYsYUFBNkI7QUFDM0IsUUFBSUMsU0FBUyxHQUFHLEVBQWhCO0FBRDJCO0FBQUE7QUFBQTs7QUFBQTtBQUUzQiwyQkFBNkIsMEJBQTdCLDhIQUE2QztBQUFBO0FBQUEsWUFBbkMzQyxRQUFtQztBQUFBLFlBQXpCRixJQUF5Qjs7QUFDM0M2QyxRQUFBQSxTQUFTLENBQUNDLElBQVYsQ0FBZW5DLGtCQUFrQixDQUFDUCxvQkFBRCxFQUFTRixRQUFULEVBQW1CRixJQUFuQixDQUFqQztBQUNEO0FBSjBCO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBSzNCLFVBQU0sd0JBQUc2QyxTQUFILENBQU47QUFDRCxHOzs7O1NBRWNFLFM7Ozs7OytDQUFmLGFBQTRCO0FBQzFCLFFBQUl2QyxnQkFBRUMsUUFBRixDQUFXaEIsT0FBTyxDQUFDdUQsSUFBbkIsRUFBeUIsT0FBekIsS0FDQXZELE9BQU8sQ0FBQ0MsR0FBUixDQUFZdUQsbUNBRGhCLEVBQ3FEO0FBQ25ELFlBQU1MLFVBQVUsRUFBaEI7QUFDRCxLQUhELE1BR08sSUFBSXBDLGdCQUFFQyxRQUFGLENBQVdoQixPQUFPLENBQUN1RCxJQUFuQixFQUF5QixlQUF6QixDQUFKLEVBQStDO0FBQ3BELFlBQU1QLGtCQUFrQixFQUF4QjtBQUNELEtBRk0sTUFFQTtBQUNMLFlBQU1ELE9BQU8sRUFBYjtBQUNEO0FBQ0YsRyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgeyBwYXJhbGxlbCBhcyBsbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHN5c3RlbSwgdGVtcERpciwgZnMsIHppcCwgbWtkaXJwIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgQ0RfVkVSIH0gZnJvbSAnLi9jaHJvbWVkcml2ZXInO1xuaW1wb3J0IHsgQ0RfQkFTRV9ESVIsIGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgsIGdldEN1clBsYXRmb3JtLFxuICAgICAgICAgZ2V0UGxhdGZvcm1zIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJ2ZhbmN5LWxvZyc7XG5cblxuZnVuY3Rpb24gbG9nIChsaW5lKSB7XG4gIGxvZ2dlcihgW0Nocm9tZWRyaXZlciBJbnN0YWxsXSAke2xpbmV9YCk7XG59XG5cbmNvbnN0IENEX0NETiA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2NkbnVybCB8fFxuICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuQ0hST01FRFJJVkVSX0NETlVSTCB8fFxuICAgICAgICAgICAgICAgJ2h0dHBzOi8vY2hyb21lZHJpdmVyLnN0b3JhZ2UuZ29vZ2xlYXBpcy5jb20nO1xuY29uc3QgQ0RfUExBVFMgPSBbJ2xpbnV4JywgJ3dpbicsICdtYWMnXTtcbmNvbnN0IENEX0FSQ0hTID0gWyczMicsICc2NCddO1xuXG5hc3luYyBmdW5jdGlvbiBnZXRBcmNoQW5kUGxhdGZvcm0gKCkge1xuICBsZXQgYXJjaCA9IGF3YWl0IHN5c3RlbS5hcmNoKCk7XG4gIGxldCBwbGF0Zm9ybSA9IGdldEN1clBsYXRmb3JtKCk7XG4gIGlmIChwbGF0Zm9ybSAhPT0gJ2xpbnV4JyAmJiBwbGF0Zm9ybSAhPT0gJ21hYycgJiYgYXJjaCA9PT0gJzY0Jykge1xuICAgIGFyY2ggPSAnMzInO1xuICB9XG4gIGlmIChwbGF0Zm9ybSA9PT0gJ21hYycgJiYgcGFyc2VGbG9hdChDRF9WRVIpIDwgMi4yMykge1xuICAgIGFyY2ggPSAnMzInO1xuICB9XG4gIHJldHVybiB7YXJjaCwgcGxhdGZvcm19O1xufVxuXG5mdW5jdGlvbiBnZXREb3dubG9hZFVybCAodmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpIHtcbiAgcmV0dXJuIGAke0NEX0NETn0vJHt2ZXJzaW9ufS9jaHJvbWVkcml2ZXJfJHtwbGF0Zm9ybX0ke2FyY2h9LnppcGA7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlUGxhdGZvcm0gKHBsYXRmb3JtLCBhcmNoKSB7XG4gIGlmICghXy5pbmNsdWRlcyhDRF9QTEFUUywgcGxhdGZvcm0pKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBsYXRmb3JtOiAke3BsYXRmb3JtfWApO1xuICB9XG4gIGlmICghXy5pbmNsdWRlcyhDRF9BUkNIUywgYXJjaCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXJjaDogJHthcmNofWApO1xuICB9XG4gIGlmIChhcmNoID09PSBcIjY0XCIgJiYgcGxhdGZvcm0gIT09IFwibGludXhcIiAmJiBwbGF0Zm9ybSAhPT0gJ21hYycpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgbGludXggaGFzIGEgNjQtYml0IHZlcnNpb24gb2YgQ2hyb21lZHJpdmVyJyk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEZvclBsYXRmb3JtICh2ZXJzaW9uLCBwbGF0Zm9ybSwgYXJjaCkge1xuICBpZiAodmVyc2lvbiA9PT0gJ0xBVEVTVCcpIHtcbiAgICB2ZXJzaW9uID0gKGF3YWl0IHJlcXVlc3QuZ2V0KHt1cmk6IGAke0NEX0NETn0vTEFURVNUX1JFTEVBU0VgfSkpLnRyaW0oKTtcbiAgfVxuICB2YWxpZGF0ZVBsYXRmb3JtKHBsYXRmb3JtLCBhcmNoKTtcblxuICBjb25zdCB1cmwgPSBnZXREb3dubG9hZFVybCh2ZXJzaW9uLCBwbGF0Zm9ybSwgYXJjaCk7XG5cbiAgbG9nKGBJbnN0YWxsaW5nIENocm9tZWRyaXZlciB2ZXJzaW9uICcke3ZlcnNpb259JyBmb3IgcGxhdGZvcm0gJyR7cGxhdGZvcm19JyBhbmQgYXJjaGl0ZWN0dXJlICcke2FyY2h9J2ApO1xuXG4gIC8vIHNldCB1cCBhIHRlbXAgZmlsZSB0byBkb3dubG9hZCB0aGUgY2hyb21lZHJpdmVyIHppcGZpbGUgdG9cbiAgY29uc3QgYmluYXJ5U3BlYyA9IGBjaHJvbWVkcml2ZXJfJHtwbGF0Zm9ybX0ke2FyY2h9YDtcbiAgbG9nKGBPcGVuaW5nIHRlbXAgZmlsZSB0byB3cml0ZSAnJHtiaW5hcnlTcGVjfScgdG8uLi5gKTtcbiAgY29uc3QgdGVtcEZpbGUgPSBhd2FpdCB0ZW1wRGlyLm9wZW4oe1xuICAgIHByZWZpeDogYmluYXJ5U3BlYyxcbiAgICBzdWZmaXg6ICcuemlwJ1xuICB9KTtcbiAgbG9nKGBPcGVuZWQgdGVtcCBmaWxlICcke3RlbXBGaWxlLnBhdGh9J2ApO1xuXG4gIC8vIGFjdHVhbGx5IGRvd25sb2FkIHRoZSB6aXBmaWxlIGFuZCB3cml0ZSBpdCB3aXRoIGFwcHJvcHJpYXRlIHBlcm1zXG4gIGxvZyhgRG93bmxvYWRpbmcgJHt1cmx9Li4uYCk7XG4gIGNvbnN0IGJvZHkgPSBhd2FpdCByZXF1ZXN0LmdldCh7dXJsLCBlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgbG9nKGBXcml0aW5nIGJpbmFyeSBjb250ZW50IHRvICR7dGVtcEZpbGUucGF0aH0uLi5gKTtcbiAgYXdhaXQgZnMud3JpdGVGaWxlKHRlbXBGaWxlLnBhdGgsIGJvZHksIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgYXdhaXQgZnMuY2htb2QodGVtcEZpbGUucGF0aCwgMG8wNjQ0KTtcblxuICAvLyBleHRyYWN0IGRvd25sb2FkZWQgemlwZmlsZSB0byB0ZW1wZGlyXG4gIGNvbnN0IHRlbXBVbnppcHBlZCA9IHBhdGgucmVzb2x2ZShwYXRoLmRpcm5hbWUodGVtcEZpbGUucGF0aCksIGJpbmFyeVNwZWMpO1xuICBsb2coYEV4dHJhY3RpbmcgJHt0ZW1wRmlsZS5wYXRofSB0byAke3RlbXBVbnppcHBlZH1gKTtcbiAgYXdhaXQgbWtkaXJwKHRlbXBVbnppcHBlZCk7XG4gIGF3YWl0IHppcC5leHRyYWN0QWxsVG8odGVtcEZpbGUucGF0aCwgdGVtcFVuemlwcGVkKTtcbiAgbGV0IGV4dHJhY3RlZEJpbiA9IHBhdGgucmVzb2x2ZSh0ZW1wVW56aXBwZWQsICdjaHJvbWVkcml2ZXInKTtcbiAgaWYgKHBsYXRmb3JtID09PSBcIndpblwiKSB7XG4gICAgZXh0cmFjdGVkQmluICs9IFwiLmV4ZVwiO1xuICB9XG5cbiAgLy8gbWFrZSBidWlsZCBkaXJzIHRoYXQgd2lsbCBob2xkIHRoZSBjaHJvbWVkcml2ZXIgYmluYXJ5XG4gIGxvZyhgQ3JlYXRpbmcgJHtwYXRoLnJlc29sdmUoQ0RfQkFTRV9ESVIsIHBsYXRmb3JtKX0uLi5gKTtcbiAgYXdhaXQgbWtkaXJwKHBhdGgucmVzb2x2ZShDRF9CQVNFX0RJUiwgcGxhdGZvcm0pKTtcblxuICAvLyBjb3B5IHRoZSBleHRyYWN0ZWQgYmluYXJ5IHRvIHRoZSBjb3JyZWN0IGJ1aWxkIGRpclxuICBjb25zdCBuZXdCaW4gPSBhd2FpdCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoKHBsYXRmb3JtLCBhcmNoKTtcbiAgbG9nKGBDb3B5aW5nIHVuemlwcGVkIGJpbmFyeSwgcmVhZGluZyBmcm9tICR7ZXh0cmFjdGVkQmlufS4uLmApO1xuICBjb25zdCBiaW5Db250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKGV4dHJhY3RlZEJpbiwge2VuY29kaW5nOiAnYmluYXJ5J30pO1xuICBsb2coYFdyaXRpbmcgdG8gJHtuZXdCaW59Li4uYCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZShuZXdCaW4sIGJpbkNvbnRlbnRzLCB7ZW5jb2Rpbmc6ICdiaW5hcnknLCBtb2RlOiAwbzc1NX0pO1xuICBsb2coYCR7bmV3QmlufSBzdWNjZXNzZnVsbHkgcHV0IGluIHBsYWNlYCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGwgKCkge1xuICBjb25zdCB7YXJjaCwgcGxhdGZvcm19ID0gYXdhaXQgZ2V0QXJjaEFuZFBsYXRmb3JtKCk7XG4gIGF3YWl0IGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29uZGl0aW9uYWxJbnN0YWxsICgpIHtcbiAgY29uc3Qge2FyY2gsIHBsYXRmb3JtfSA9IGF3YWl0IGdldEFyY2hBbmRQbGF0Zm9ybSgpO1xuICBjb25zdCBiaW5QYXRoID0gYXdhaXQgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aChwbGF0Zm9ybSwgYXJjaCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGJpblBhdGgpKSB7XG4gICAgYXdhaXQgaW5zdGFsbEZvclBsYXRmb3JtKENEX1ZFUiwgcGxhdGZvcm0sIGFyY2gpO1xuICB9IGVsc2Uge1xuICAgIGxvZyhgTm8gbmVlZCB0byBpbnN0YWxsIGNocm9tZWRyaXZlciwgJHtiaW5QYXRofSBleGlzdHNgKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsQWxsICgpIHtcbiAgbGV0IGRvd25sb2FkcyA9IFtdO1xuICBmb3IgKGxldCBbcGxhdGZvcm0sIGFyY2hdIG9mIGdldFBsYXRmb3JtcygpKSB7XG4gICAgZG93bmxvYWRzLnB1c2goaW5zdGFsbEZvclBsYXRmb3JtKENEX1ZFUiwgcGxhdGZvcm0sIGFyY2gpKTtcbiAgfVxuICBhd2FpdCBsbChkb3dubG9hZHMpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkb0luc3RhbGwgKCkge1xuICBpZiAoXy5pbmNsdWRlcyhwcm9jZXNzLmFyZ3YsICctLWFsbCcpIHx8XG4gICAgICBwcm9jZXNzLmVudi5ucG1fY29uZmlnX2Nocm9tZWRyaXZlcl9pbnN0YWxsX2FsbCkge1xuICAgIGF3YWl0IGluc3RhbGxBbGwoKTtcbiAgfSBlbHNlIGlmIChfLmluY2x1ZGVzKHByb2Nlc3MuYXJndiwgJy0tY29uZGl0aW9uYWwnKSkge1xuICAgIGF3YWl0IGNvbmRpdGlvbmFsSW5zdGFsbCgpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IGluc3RhbGwoKTtcbiAgfVxufVxuXG5leHBvcnQgeyBpbnN0YWxsLCBpbnN0YWxsQWxsLCBjb25kaXRpb25hbEluc3RhbGwsIGRvSW5zdGFsbCB9O1xuIl0sImZpbGUiOiJsaWIvaW5zdGFsbC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
