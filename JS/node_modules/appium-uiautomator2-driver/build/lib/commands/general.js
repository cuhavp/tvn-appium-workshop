"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

let extensions = {},
    commands = {},
    helpers = {};
commands.getPageSource = (0, _asyncToGenerator2.default)(function* () {
  return yield this.uiautomator2.jwproxy.command('/source', 'GET', {});
});

commands.doSendKeys = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (params) {
    yield this.uiautomator2.jwproxy.command('/keys', 'POST', params);
  });

  return function (_x) {
    return _ref2.apply(this, arguments);
  };
}();

commands.keyevent = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (keycode, metastate) {
    _logger.default.debug(`Ignoring metastate ${metastate}`);

    yield this.adb.keyevent(keycode);
  });

  return function (_x2, _x3) {
    return _ref3.apply(this, arguments);
  };
}();

commands.back = (0, _asyncToGenerator2.default)(function* () {
  yield this.adb.keyevent(4);
});

commands.getStrings = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (language) {
    if (!language) {
      language = yield this.adb.getDeviceLanguage();

      _logger.default.info(`No language specified, returning strings for: ${language}`);
    }

    const preprocessStringsMap = function preprocessStringsMap(mapping) {
      const result = {};
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = _lodash.default.toPairs(mapping)[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          const _step$value = (0, _slicedToArray2.default)(_step.value, 2),
                key = _step$value[0],
                value = _step$value[1];

          result[key] = _lodash.default.isString(value) ? value : JSON.stringify(value);
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      return result;
    };

    if (this.apkStrings[language]) {
      return preprocessStringsMap(this.apkStrings[language]);
    }

    if (!this.opts.app && !this.opts.appPackage) {
      _logger.default.errorAndThrow("One of 'app' or 'appPackage' capabilities should must be specified");
    }

    let app = this.opts.app;
    const tmpRoot = yield _appiumSupport.tempDir.openDir();

    try {
      if (!app) {
        try {
          app = yield this.adb.pullApk(this.opts.appPackage, tmpRoot);
        } catch (err) {
          _logger.default.errorAndThrow(`Failed to pull an apk from '${this.opts.appPackage}'. Original error: ${err.message}`);
        }
      }

      if (!(yield _appiumSupport.fs.exists(app))) {
        _logger.default.errorAndThrow(`The app at '${app}' does not exist`);
      }

      try {
        const _ref6 = yield this.adb.extractStringsFromApk(app, language, tmpRoot),
              apkStrings = _ref6.apkStrings;

        this.apkStrings[language] = apkStrings;
        return preprocessStringsMap(apkStrings);
      } catch (err) {
        _logger.default.errorAndThrow(`Cannot extract strings from '${app}'. Original error: ${err.message}`);
      }
    } finally {
      yield _appiumSupport.fs.rimraf(tmpRoot);
    }
  });

  return function (_x4) {
    return _ref5.apply(this, arguments);
  };
}();

commands.getWindowSize = (0, _asyncToGenerator2.default)(function* () {
  return yield this.uiautomator2.jwproxy.command('/window/current/size', 'GET', {});
});
commands.getWindowRect = (0, _asyncToGenerator2.default)(function* () {
  const _ref9 = yield this.getWindowSize(),
        width = _ref9.width,
        height = _ref9.height;

  return {
    width,
    height,
    x: 0,
    y: 0
  };
});

extensions.executeMobile = function () {
  var _ref10 = (0, _asyncToGenerator2.default)(function* (mobileCommand, opts = {}) {
    const mobileCommandsMapping = {
      shell: 'mobileShell',
      scrollBackTo: 'mobileScrollBackTo',
      viewportScreenshot: 'mobileViewportScreenshot',
      deepLink: 'mobileDeepLink',
      startLogsBroadcast: 'mobileStartLogsBroadcast',
      stopLogsBroadcast: 'mobileStopLogsBroadcast',
      acceptAlert: 'mobileAcceptAlert',
      dismissAlert: 'mobileDismissAlert',
      batteryInfo: 'mobileGetBatteryInfo',
      deviceInfo: 'mobileGetDeviceInfo',
      performEditorAction: 'mobilePerformEditorAction'
    };

    if (!_lodash.default.has(mobileCommandsMapping, mobileCommand)) {
      throw new _appiumBaseDriver.errors.UnknownCommandError(`Unknown mobile command "${mobileCommand}". ` + `Only ${_lodash.default.keys(mobileCommandsMapping)} commands are supported.`);
    }

    return yield this[mobileCommandsMapping[mobileCommand]](opts);
  });

  return function (_x5) {
    return _ref10.apply(this, arguments);
  };
}();

commands.mobileScrollBackTo = function () {
  var _ref11 = (0, _asyncToGenerator2.default)(function* (opts) {
    const elementId = opts.elementId,
          elementToId = opts.elementToId;
    return yield this.uiautomator2.jwproxy.command(`/appium/element/${elementId}/scroll_to/${elementToId}`, 'POST', {});
  });

  return function (_x6) {
    return _ref11.apply(this, arguments);
  };
}();

commands.mobileViewportScreenshot = (0, _asyncToGenerator2.default)(function* () {
  return yield this.getViewportScreenshot();
});

commands.setUrl = function () {
  var _ref13 = (0, _asyncToGenerator2.default)(function* (url) {
    yield this.adb.startUri(url, this.opts.appPackage);
  });

  return function (_x7) {
    return _ref13.apply(this, arguments);
  };
}();

commands.mobileDeepLink = function () {
  var _ref14 = (0, _asyncToGenerator2.default)(function* (opts = {}) {
    const url = opts.url,
          pkg = opts.package;
    return yield this.adb.startUri(url, pkg);
  });

  return function () {
    return _ref14.apply(this, arguments);
  };
}();

commands.openNotifications = (0, _asyncToGenerator2.default)(function* () {
  return yield this.uiautomator2.jwproxy.command('/appium/device/open_notifications', 'POST', {});
});

commands.updateSettings = function () {
  var _ref16 = (0, _asyncToGenerator2.default)(function* (settings) {
    let driverOnlySettings = {};
    let serverSettings = {};
    var _iteratorNormalCompletion2 = true;
    var _didIteratorError2 = false;
    var _iteratorError2 = undefined;

    try {
      for (var _iterator2 = _lodash.default.toPairs(settings)[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
        let _step2$value = (0, _slicedToArray2.default)(_step2.value, 2),
            setting = _step2$value[0],
            value = _step2$value[1];

        if (_appiumBaseDriver.BASEDRIVER_HANDLED_SETTINGS.includes(setting)) {
          driverOnlySettings[setting] = value;
        } else {
          serverSettings[setting] = value;
        }
      }
    } catch (err) {
      _didIteratorError2 = true;
      _iteratorError2 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
          _iterator2.return();
        }
      } finally {
        if (_didIteratorError2) {
          throw _iteratorError2;
        }
      }
    }

    if (!_lodash.default.isEmpty(driverOnlySettings)) {
      _logger.default.info(`Found some settings designed to be handled by BaseDriver: ` + `${JSON.stringify(_lodash.default.keys(driverOnlySettings))}. Not ` + `sending these on to the UiAutomator2 server and instead ` + `setting directly on the driver`);

      yield this.settings.update(driverOnlySettings);
    }

    if (!_lodash.default.isEmpty(serverSettings)) {
      _logger.default.info('Forwarding the following settings to the UiAutomator2 server: ' + JSON.stringify(_lodash.default.keys(serverSettings)));

      yield this.uiautomator2.jwproxy.command('/appium/settings', 'POST', {
        settings: serverSettings
      });
    }
  });

  return function (_x8) {
    return _ref16.apply(this, arguments);
  };
}();

commands.getSettings = (0, _asyncToGenerator2.default)(function* () {
  const driverOnlySettings = this.settings.getSettings();
  const serverSettings = yield this.uiautomator2.jwproxy.command('/appium/settings', 'GET');
  return (0, _objectSpread2.default)({}, driverOnlySettings, serverSettings);
});

helpers.wrapBootstrapDisconnect = function () {
  var _ref18 = (0, _asyncToGenerator2.default)(function* (wrapped) {
    yield wrapped();
  });

  return function (_x9) {
    return _ref18.apply(this, arguments);
  };
}();

helpers.suspendChromedriverProxy = function () {
  this.chromedriver = null;
  this.proxyReqRes = this.uiautomator2.proxyReqRes.bind(this.uiautomator2);
  this.jwpProxyActive = true;
};

commands.mobileGetDeviceInfo = (0, _asyncToGenerator2.default)(function* () {
  return yield this.uiautomator2.jwproxy.command('/appium/device/info', 'GET');
});
Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbImV4dGVuc2lvbnMiLCJjb21tYW5kcyIsImhlbHBlcnMiLCJnZXRQYWdlU291cmNlIiwidWlhdXRvbWF0b3IyIiwiandwcm94eSIsImNvbW1hbmQiLCJkb1NlbmRLZXlzIiwicGFyYW1zIiwia2V5ZXZlbnQiLCJrZXljb2RlIiwibWV0YXN0YXRlIiwibG9nIiwiZGVidWciLCJhZGIiLCJiYWNrIiwiZ2V0U3RyaW5ncyIsImxhbmd1YWdlIiwiZ2V0RGV2aWNlTGFuZ3VhZ2UiLCJpbmZvIiwicHJlcHJvY2Vzc1N0cmluZ3NNYXAiLCJtYXBwaW5nIiwicmVzdWx0IiwiXyIsInRvUGFpcnMiLCJrZXkiLCJ2YWx1ZSIsImlzU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImFwa1N0cmluZ3MiLCJvcHRzIiwiYXBwIiwiYXBwUGFja2FnZSIsImVycm9yQW5kVGhyb3ciLCJ0bXBSb290IiwidGVtcERpciIsIm9wZW5EaXIiLCJwdWxsQXBrIiwiZXJyIiwibWVzc2FnZSIsImZzIiwiZXhpc3RzIiwiZXh0cmFjdFN0cmluZ3NGcm9tQXBrIiwicmltcmFmIiwiZ2V0V2luZG93U2l6ZSIsImdldFdpbmRvd1JlY3QiLCJ3aWR0aCIsImhlaWdodCIsIngiLCJ5IiwiZXhlY3V0ZU1vYmlsZSIsIm1vYmlsZUNvbW1hbmQiLCJtb2JpbGVDb21tYW5kc01hcHBpbmciLCJzaGVsbCIsInNjcm9sbEJhY2tUbyIsInZpZXdwb3J0U2NyZWVuc2hvdCIsImRlZXBMaW5rIiwic3RhcnRMb2dzQnJvYWRjYXN0Iiwic3RvcExvZ3NCcm9hZGNhc3QiLCJhY2NlcHRBbGVydCIsImRpc21pc3NBbGVydCIsImJhdHRlcnlJbmZvIiwiZGV2aWNlSW5mbyIsInBlcmZvcm1FZGl0b3JBY3Rpb24iLCJoYXMiLCJlcnJvcnMiLCJVbmtub3duQ29tbWFuZEVycm9yIiwia2V5cyIsIm1vYmlsZVNjcm9sbEJhY2tUbyIsImVsZW1lbnRJZCIsImVsZW1lbnRUb0lkIiwibW9iaWxlVmlld3BvcnRTY3JlZW5zaG90IiwiZ2V0Vmlld3BvcnRTY3JlZW5zaG90Iiwic2V0VXJsIiwidXJsIiwic3RhcnRVcmkiLCJtb2JpbGVEZWVwTGluayIsInBrZyIsInBhY2thZ2UiLCJvcGVuTm90aWZpY2F0aW9ucyIsInVwZGF0ZVNldHRpbmdzIiwic2V0dGluZ3MiLCJkcml2ZXJPbmx5U2V0dGluZ3MiLCJzZXJ2ZXJTZXR0aW5ncyIsInNldHRpbmciLCJCQVNFRFJJVkVSX0hBTkRMRURfU0VUVElOR1MiLCJpbmNsdWRlcyIsImlzRW1wdHkiLCJ1cGRhdGUiLCJnZXRTZXR0aW5ncyIsIndyYXBCb290c3RyYXBEaXNjb25uZWN0Iiwid3JhcHBlZCIsInN1c3BlbmRDaHJvbWVkcml2ZXJQcm94eSIsImNocm9tZWRyaXZlciIsInByb3h5UmVxUmVzIiwiYmluZCIsImp3cFByb3h5QWN0aXZlIiwibW9iaWxlR2V0RGV2aWNlSW5mbyIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsVUFBVSxHQUFHLEVBQWpCO0FBQUEsSUFDSUMsUUFBUSxHQUFHLEVBRGY7QUFBQSxJQUVJQyxPQUFPLEdBQUcsRUFGZDtBQUlBRCxRQUFRLENBQUNFLGFBQVQsbUNBQXlCLGFBQWtCO0FBQ3pDLGVBQWEsS0FBS0MsWUFBTCxDQUFrQkMsT0FBbEIsQ0FBMEJDLE9BQTFCLENBQWtDLFNBQWxDLEVBQTZDLEtBQTdDLEVBQW9ELEVBQXBELENBQWI7QUFDRCxDQUZEOztBQUtBTCxRQUFRLENBQUNNLFVBQVQ7QUFBQSw4Q0FBc0IsV0FBZ0JDLE1BQWhCLEVBQXdCO0FBQzVDLFVBQU0sS0FBS0osWUFBTCxDQUFrQkMsT0FBbEIsQ0FBMEJDLE9BQTFCLENBQWtDLE9BQWxDLEVBQTJDLE1BQTNDLEVBQW1ERSxNQUFuRCxDQUFOO0FBQ0QsR0FGRDs7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUFLQVAsUUFB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QW9CLElBQXBCO0FBQ0EsT0FBS0MsV0FBTCxHQUFtQixLQUFLM0YsWUFBTCxDQUFrQjJGLFdBQWxCLENBQThCQyxJQUE5QixDQUFtQyxLQUFLNUYsWUFBeEMsQ0FBbkI7QUFDQSxPQUFLNkYsY0FBTCxHQUFzQixJQUF0QjtBQUNELENBSkQ7O0FBVUFoRyxRQUFRLENBQUNpRyxtQkFBVCxtQ0FBK0IsYUFBa0I7QUFDL0MsZUFBYSxLQUFLOUYsWUFBTCxDQUFrQkMsT0FBbEIsQ0FBMEJDLE9BQTFCLENBQWtDLHFCQUFsQyxFQUF5RCxLQUF6RCxDQUFiO0FBQ0QsQ0FGRDtBQUlBNkYsTUFBTSxDQUFDQyxNQUFQLENBQWNwRyxVQUFkLEVBQTBCQyxRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUYsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvcnMsIEJBU0VEUklWRVJfSEFORExFRF9TRVRUSU5HUyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBmcywgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxubGV0IGV4dGVuc2lvbnMgPSB7fSxcbiAgICBjb21tYW5kcyA9IHt9LFxuICAgIGhlbHBlcnMgPSB7fTtcblxuY29tbWFuZHMuZ2V0UGFnZVNvdXJjZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMudWlhdXRvbWF0b3IyLmp3cHJveHkuY29tbWFuZCgnL3NvdXJjZScsICdHRVQnLCB7fSk7XG59O1xuXG4vLyBOZWVkIHRvIG92ZXJyaWRlIHRoaXMgZm9yIGNvcnJlY3QgdW5pY29kZSBzdXBwb3J0XG5jb21tYW5kcy5kb1NlbmRLZXlzID0gYXN5bmMgZnVuY3Rpb24gKHBhcmFtcykge1xuICBhd2FpdCB0aGlzLnVpYXV0b21hdG9yMi5qd3Byb3h5LmNvbW1hbmQoJy9rZXlzJywgJ1BPU1QnLCBwYXJhbXMpO1xufTtcblxuLy8gdWlhdXRvbWF0b3IyIGRvZXNuJ3Qgc3VwcG9ydCBtZXRhc3RhdGUgZm9yIGtleWV2ZW50c1xuY29tbWFuZHMua2V5ZXZlbnQgPSBhc3luYyBmdW5jdGlvbiAoa2V5Y29kZSwgbWV0YXN0YXRlKSB7XG4gIGxvZy5kZWJ1ZyhgSWdub3JpbmcgbWV0YXN0YXRlICR7bWV0YXN0YXRlfWApO1xuICBhd2FpdCB0aGlzLmFkYi5rZXlldmVudChrZXljb2RlKTtcbn07XG5cbi8vIFVzZSBBREIgc2luY2Ugd2UgZG9uJ3QgaGF2ZSBVaUF1dG9tYXRvclxuY29tbWFuZHMuYmFjayA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgYXdhaXQgdGhpcy5hZGIua2V5ZXZlbnQoNCk7XG59O1xuXG5jb21tYW5kcy5nZXRTdHJpbmdzID0gYXN5bmMgZnVuY3Rpb24gKGxhbmd1YWdlKSB7XG4gIGlmICghbGFuZ3VhZ2UpIHtcbiAgICBsYW5ndWFnZSA9IGF3YWl0IHRoaXMuYWRiLmdldERldmljZUxhbmd1YWdlKCk7XG4gICAgbG9nLmluZm8oYE5vIGxhbmd1YWdlIHNwZWNpZmllZCwgcmV0dXJuaW5nIHN0cmluZ3MgZm9yOiAke2xhbmd1YWdlfWApO1xuICB9XG5cbiAgLy8gQ2xpZW50cyByZXF1aXJlIHRoZSByZXN1bHRpbmcgbWFwcGluZyB0byBoYXZlIGJvdGgga2V5c1xuICAvLyBhbmQgdmFsdWVzIG9mIHR5cGUgc3RyaW5nXG4gIGNvbnN0IHByZXByb2Nlc3NTdHJpbmdzTWFwID0gZnVuY3Rpb24gKG1hcHBpbmcpIHtcbiAgICBjb25zdCByZXN1bHQgPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMobWFwcGluZykpIHtcbiAgICAgIHJlc3VsdFtrZXldID0gXy5pc1N0cmluZyh2YWx1ZSkgPyB2YWx1ZSA6IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfTtcblxuICBpZiAodGhpcy5hcGtTdHJpbmdzW2xhbmd1YWdlXSkge1xuICAgIC8vIFJldHVybiBjYWNoZWQgc3RyaW5nc1xuICAgIHJldHVybiBwcmVwcm9jZXNzU3RyaW5nc01hcCh0aGlzLmFwa1N0cmluZ3NbbGFuZ3VhZ2VdKTtcbiAgfVxuXG4gIGlmICghdGhpcy5vcHRzLmFwcCAmJiAhdGhpcy5vcHRzLmFwcFBhY2thZ2UpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhcIk9uZSBvZiAnYXBwJyBvciAnYXBwUGFja2FnZScgY2FwYWJpbGl0aWVzIHNob3VsZCBtdXN0IGJlIHNwZWNpZmllZFwiKTtcbiAgfVxuXG4gIGxldCBhcHAgPSB0aGlzLm9wdHMuYXBwO1xuICBjb25zdCB0bXBSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIHRyeSB7XG4gICAgaWYgKCFhcHApIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGFwcCA9IGF3YWl0IHRoaXMuYWRiLnB1bGxBcGsodGhpcy5vcHRzLmFwcFBhY2thZ2UsIHRtcFJvb3QpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBGYWlsZWQgdG8gcHVsbCBhbiBhcGsgZnJvbSAnJHt0aGlzLm9wdHMuYXBwUGFja2FnZX0nLiBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhhcHApKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIGFwcCBhdCAnJHthcHB9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCB7YXBrU3RyaW5nc30gPSBhd2FpdCB0aGlzLmFkYi5leHRyYWN0U3RyaW5nc0Zyb21BcGsoYXBwLCBsYW5ndWFnZSwgdG1wUm9vdCk7XG4gICAgICB0aGlzLmFwa1N0cmluZ3NbbGFuZ3VhZ2VdID0gYXBrU3RyaW5ncztcbiAgICAgIHJldHVybiBwcmVwcm9jZXNzU3RyaW5nc01hcChhcGtTdHJpbmdzKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KGBDYW5ub3QgZXh0cmFjdCBzdHJpbmdzIGZyb20gJyR7YXBwfScuIE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gIH1cbn07XG5cbi8vIG1lbW9pemVkIGluIGNvbnN0cnVjdG9yXG5jb21tYW5kcy5nZXRXaW5kb3dTaXplID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy51aWF1dG9tYXRvcjIuandwcm94eS5jb21tYW5kKCcvd2luZG93L2N1cnJlbnQvc2l6ZScsICdHRVQnLCB7fSk7XG59O1xuXG4vLyBGb3IgVzNDXG5jb21tYW5kcy5nZXRXaW5kb3dSZWN0ID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFdpbmRvd1NpemUoKTtcbiAgcmV0dXJuIHtcbiAgICB3aWR0aCxcbiAgICBoZWlnaHQsXG4gICAgeDogMCxcbiAgICB5OiAwLFxuICB9O1xufTtcblxuZXh0ZW5zaW9ucy5leGVjdXRlTW9iaWxlID0gYXN5bmMgZnVuY3Rpb24gKG1vYmlsZUNvbW1hbmQsIG9wdHMgPSB7fSkge1xuICBjb25zdCBtb2JpbGVDb21tYW5kc01hcHBpbmcgPSB7XG4gICAgc2hlbGw6ICdtb2JpbGVTaGVsbCcsXG5cbiAgICBzY3JvbGxCYWNrVG86ICdtb2JpbGVTY3JvbGxCYWNrVG8nLFxuICAgIHZpZXdwb3J0U2NyZWVuc2hvdDogJ21vYmlsZVZpZXdwb3J0U2NyZWVuc2hvdCcsXG5cbiAgICBkZWVwTGluazogJ21vYmlsZURlZXBMaW5rJyxcblxuICAgIHN0YXJ0TG9nc0Jyb2FkY2FzdDogJ21vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCcsXG4gICAgc3RvcExvZ3NCcm9hZGNhc3Q6ICdtb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCcsXG5cbiAgICBhY2NlcHRBbGVydDogJ21vYmlsZUFjY2VwdEFsZXJ0JyxcbiAgICBkaXNtaXNzQWxlcnQ6ICdtb2JpbGVEaXNtaXNzQWxlcnQnLFxuXG4gICAgYmF0dGVyeUluZm86ICdtb2JpbGVHZXRCYXR0ZXJ5SW5mbycsXG5cbiAgICBkZXZpY2VJbmZvOiAnbW9iaWxlR2V0RGV2aWNlSW5mbycsXG5cbiAgICBwZXJmb3JtRWRpdG9yQWN0aW9uOiAnbW9iaWxlUGVyZm9ybUVkaXRvckFjdGlvbicsXG4gIH07XG5cbiAgaWYgKCFfLmhhcyhtb2JpbGVDb21tYW5kc01hcHBpbmcsIG1vYmlsZUNvbW1hbmQpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duQ29tbWFuZEVycm9yKGBVbmtub3duIG1vYmlsZSBjb21tYW5kIFwiJHttb2JpbGVDb21tYW5kfVwiLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYE9ubHkgJHtfLmtleXMobW9iaWxlQ29tbWFuZHNNYXBwaW5nKX0gY29tbWFuZHMgYXJlIHN1cHBvcnRlZC5gKTtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpc1ttb2JpbGVDb21tYW5kc01hcHBpbmdbbW9iaWxlQ29tbWFuZF1dKG9wdHMpO1xufTtcblxuY29tbWFuZHMubW9iaWxlU2Nyb2xsQmFja1RvID0gYXN5bmMgZnVuY3Rpb24gKG9wdHMpIHtcbiAgY29uc3Qge2VsZW1lbnRJZCwgZWxlbWVudFRvSWR9ID0gb3B0cztcbiAgcmV0dXJuIGF3YWl0IHRoaXMudWlhdXRvbWF0b3IyLmp3cHJveHkuY29tbWFuZChgL2FwcGl1bS9lbGVtZW50LyR7ZWxlbWVudElkfS9zY3JvbGxfdG8vJHtlbGVtZW50VG9JZH1gLCAnUE9TVCcsIHt9KTtcbn07XG5cbmNvbW1hbmRzLm1vYmlsZVZpZXdwb3J0U2NyZWVuc2hvdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0Vmlld3BvcnRTY3JlZW5zaG90KCk7XG59O1xuXG5jb21tYW5kcy5zZXRVcmwgPSBhc3luYyBmdW5jdGlvbiAodXJsKSB7XG4gIGF3YWl0IHRoaXMuYWRiLnN0YXJ0VXJpKHVybCwgdGhpcy5vcHRzLmFwcFBhY2thZ2UpO1xufTtcblxuY29tbWFuZHMubW9iaWxlRGVlcExpbmsgPSBhc3luYyBmdW5jdGlvbiAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHt1cmwsIHBhY2thZ2U6IHBrZ30gPSBvcHRzO1xuICByZXR1cm4gYXdhaXQgdGhpcy5hZGIuc3RhcnRVcmkodXJsLCBwa2cpO1xufTtcblxuY29tbWFuZHMub3Blbk5vdGlmaWNhdGlvbnMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLnVpYXV0b21hdG9yMi5qd3Byb3h5LmNvbW1hbmQoJy9hcHBpdW0vZGV2aWNlL29wZW5fbm90aWZpY2F0aW9ucycsICdQT1NUJywge30pO1xufTtcblxuY29tbWFuZHMudXBkYXRlU2V0dGluZ3MgPSBhc3luYyBmdW5jdGlvbiAoc2V0dGluZ3MpIHtcbiAgLy8gd2UgaGF2ZSBzb21lIHNldHRpbmdzIHRoYXQgYXJlIHNldCBvbiB0aGUgc2V0dGluZ3Mgb2JqZWN0IGluIHRoZSBkcml2ZXJcbiAgLy8gb25seSwgZm9yIGV4YW1wbGUgaW1hZ2UgZmluZGluZyBzZXR0aW5ncy4gVGhlIHVpYXV0bzIgc2VydmVyIGRvZXMgbm90IGtub3dcbiAgLy8gd2hhdCB0byBkbyB3aXRoIHRoZW0sIHNvIGp1c3Qgc2V0IHRoZW0gb24gdGhpcyBkcml2ZXIncyBzZXR0aW5ncyBpbnN0YW5jZSxcbiAgLy8gYW5kIGRvbid0IGZvcndhcmQgdGhlbSB0byB0aGUgc2VydmVyXG4gIGxldCBkcml2ZXJPbmx5U2V0dGluZ3MgPSB7fTtcbiAgbGV0IHNlcnZlclNldHRpbmdzID0ge307XG4gIGZvciAobGV0IFtzZXR0aW5nLCB2YWx1ZV0gb2YgXy50b1BhaXJzKHNldHRpbmdzKSkge1xuICAgIGlmIChCQVNFRFJJVkVSX0hBTkRMRURfU0VUVElOR1MuaW5jbHVkZXMoc2V0dGluZykpIHtcbiAgICAgIGRyaXZlck9ubHlTZXR0aW5nc1tzZXR0aW5nXSA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBzZXJ2ZXJTZXR0aW5nc1tzZXR0aW5nXSA9IHZhbHVlO1xuICAgIH1cbiAgfVxuICBpZiAoIV8uaXNFbXB0eShkcml2ZXJPbmx5U2V0dGluZ3MpKSB7XG4gICAgbG9nLmluZm8oYEZvdW5kIHNvbWUgc2V0dGluZ3MgZGVzaWduZWQgdG8gYmUgaGFuZGxlZCBieSBCYXNlRHJpdmVyOiBgICtcbiAgICAgICAgICAgICBgJHtKU09OLnN0cmluZ2lmeShfLmtleXMoZHJpdmVyT25seVNldHRpbmdzKSl9LiBOb3QgYCArXG4gICAgICAgICAgICAgYHNlbmRpbmcgdGhlc2Ugb24gdG8gdGhlIFVpQXV0b21hdG9yMiBzZXJ2ZXIgYW5kIGluc3RlYWQgYCArXG4gICAgICAgICAgICAgYHNldHRpbmcgZGlyZWN0bHkgb24gdGhlIGRyaXZlcmApO1xuICAgIGF3YWl0IHRoaXMuc2V0dGluZ3MudXBkYXRlKGRyaXZlck9ubHlTZXR0aW5ncyk7XG4gIH1cbiAgaWYgKCFfLmlzRW1wdHkoc2VydmVyU2V0dGluZ3MpKSB7XG4gICAgbG9nLmluZm8oJ0ZvcndhcmRpbmcgdGhlIGZvbGxvd2luZyBzZXR0aW5ncyB0byB0aGUgVWlBdXRvbWF0b3IyIHNlcnZlcjogJyArXG4gICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkoXy5rZXlzKHNlcnZlclNldHRpbmdzKSkpO1xuICAgIGF3YWl0IHRoaXMudWlhdXRvbWF0b3IyLmp3cHJveHkuY29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdQT1NUJyxcbiAgICAgIHtzZXR0aW5nczogc2VydmVyU2V0dGluZ3N9KTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0U2V0dGluZ3MgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIC8vIGFzIGFib3ZlLCB3ZSBtaWdodCBoYXZlIHNvbWUgZHJpdmVyLW9ubHkgc2V0dGluZ3MgdG8gcmV0dXJuIGFzIHdlbGxcbiAgY29uc3QgZHJpdmVyT25seVNldHRpbmdzID0gdGhpcy5zZXR0aW5ncy5nZXRTZXR0aW5ncygpO1xuICBjb25zdCBzZXJ2ZXJTZXR0aW5ncyA9IGF3YWl0IHRoaXMudWlhdXRvbWF0b3IyLmp3cHJveHkuY29tbWFuZCgnL2FwcGl1bS9zZXR0aW5ncycsICdHRVQnKTtcbiAgcmV0dXJuIHsuLi5kcml2ZXJPbmx5U2V0dGluZ3MsIC4uLnNlcnZlclNldHRpbmdzfTtcbn07XG5cbi8qKlxuICogT3ZlcnJpZGluZyBhcHBpdW0tYW5kcm9pZC1kcml2ZXIncyB3cmFwQm9vdHN0cmFwRGlzY29ubmVjdCxcbiAqIHVubGlrZSBpbiBhcHBpdW0tYW5kcm9pZC1kcml2ZXIgYXZvaWRpbmcgYWRiIHJlc3RhcnRpbmcgYXMgaXQgaW50ZXJuXG4gKiBraWxscyBVaUF1dG9tYXRvcjIgc2VydmVyIHJ1bm5pbmcgaW4gdGhlIGRldmljZS5cbiAqKi9cbmhlbHBlcnMud3JhcEJvb3RzdHJhcERpc2Nvbm5lY3QgPSBhc3luYyBmdW5jdGlvbiAod3JhcHBlZCkge1xuICBhd2FpdCB3cmFwcGVkKCk7XG59O1xuXG4vLyBTdG9wIHByb3h5aW5nIHRvIGFueSBDaHJvbWVkcml2ZXIgYW5kIHJlZGlyZWN0IHRvIHVpYXV0b21hdG9yMlxuaGVscGVycy5zdXNwZW5kQ2hyb21lZHJpdmVyUHJveHkgPSBmdW5jdGlvbiAoKSB7XG4gIHRoaXMuY2hyb21lZHJpdmVyID0gbnVsbDtcbiAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMudWlhdXRvbWF0b3IyLnByb3h5UmVxUmVzLmJpbmQodGhpcy51aWF1dG9tYXRvcjIpO1xuICB0aGlzLmp3cFByb3h5QWN0aXZlID0gdHJ1ZTtcbn07XG5cbi8qKlxuICogVGhlIGxpc3Qgb2YgYXZhaWxhYmxlIGluZm8gZW50cmllcyBjYW4gYmUgZm91bmQgYXRcbiAqIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtLXVpYXV0b21hdG9yMi1zZXJ2ZXIvYmxvYi9tYXN0ZXIvYXBwL3NyYy9tYWluL2phdmEvaW8vYXBwaXVtL3VpYXV0b21hdG9yMi9oYW5kbGVyL0dldERldmljZUluZm8uamF2YVxuICovXG5jb21tYW5kcy5tb2JpbGVHZXREZXZpY2VJbmZvID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy51aWF1dG9tYXRvcjIuandwcm94eS5jb21tYW5kKCcvYXBwaXVtL2RldmljZS9pbmZvJywgJ0dFVCcpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
