"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _chai = _interopRequireDefault(require("chai"));

var _path = _interopRequireDefault(require("path"));

var _chaiAsPromised = _interopRequireDefault(require("chai-as-promised"));

var _appiumSupport = require("appium-support");

var _helpers = _interopRequireDefault(require("../../lib/basedriver/helpers"));

var _http = _interopRequireDefault(require("http"));

var _finalhandler = _interopRequireDefault(require("finalhandler"));

var _serveStatic = _interopRequireDefault(require("serve-static"));

var _contentDisposition = _interopRequireDefault(require("content-disposition"));

var _bluebird = _interopRequireDefault(require("bluebird"));

_chai.default.should();

_chai.default.use(_chaiAsPromised.default);

function getFixture(file) {
  return _path.default.resolve(__dirname, '..', '..', '..', 'test', 'basedriver', 'fixtures', file);
}

describe('app download and configuration', function () {
  describe('configureApp', function () {
    it('should get the path for a local .app', (0, _asyncToGenerator2.default)(function* () {
      let newAppPath = yield _helpers.default.configureApp(getFixture('FakeIOSApp.app'), '.app');
      newAppPath.should.contain('FakeIOSApp.app');
      let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
      contents.should.eql('this is not really an app\n');
    }));
    it('should get the path for a local .apk', (0, _asyncToGenerator2.default)(function* () {
      let newAppPath = yield _helpers.default.configureApp(getFixture('FakeAndroidApp.apk'), '.apk');
      newAppPath.should.contain('FakeAndroidApp.apk');
      let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
      contents.should.eql('this is not really an apk\n');
    }));
    it('should unzip and get the path for a local .app.zip', (0, _asyncToGenerator2.default)(function* () {
      let newAppPath = yield _helpers.default.configureApp(getFixture('FakeIOSApp.app.zip'), '.app');
      newAppPath.should.contain('FakeIOSApp.app');
      let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
      contents.should.eql('this is not really an app\n');
    }));
    it('should unzip and get the path for a local .ipa', (0, _asyncToGenerator2.default)(function* () {
      let newAppPath = yield _helpers.default.configureApp(getFixture('FakeIOSApp.ipa'), '.app');
      newAppPath.should.contain('FakeIOSApp.app');
      let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
      contents.should.eql('this is not really an app\n');
    }));
    it('should fail for a bad zip file', (0, _asyncToGenerator2.default)(function* () {
      yield _helpers.default.configureApp(getFixture('BadZippedApp.zip'), '.app').should.be.rejectedWith('Error testing zip archive, are you sure this is a zip file?');
    }));
    it('should fail if extensions do not match', (0, _asyncToGenerator2.default)(function* () {
      yield _helpers.default.configureApp(getFixture('FakeIOSApp.app'), '.wrong').should.be.rejectedWith(/did not have extension '.wrong'/);
    }));
    it('should fail if zip file does not contain an app whose extension matches', (0, _asyncToGenerator2.default)(function* () {
      yield _helpers.default.configureApp(getFixture('FakeIOSApp.app.zip'), '.wrong').should.be.rejectedWith(/could not find a .wrong bundle in it/);
    }));
    describe('should download an app from the web', function () {
      const port = 8000;
      const serverUrl = `http://localhost:${port}`;
      describe('server not available', function () {
        it('should handle server not available', (0, _asyncToGenerator2.default)(function* () {
          yield _helpers.default.configureApp(`${serverUrl}/FakeIOSApp.app.zip`, '.app').should.eventually.be.rejectedWith(/ECONNREFUSED/);
        }));
      });
      describe('server available', function () {
        let server;
        before(function () {
          const dir = _path.default.resolve(__dirname, '..', '..', '..', 'test', 'basedriver', 'fixtures');

          const serve = (0, _serveStatic.default)(dir, {
            index: false,
            setHeaders: (res, path) => {
              res.setHeader('Content-Disposition', (0, _contentDisposition.default)(path));
            }
          });
          server = _http.default.createServer(function (req, res) {
            if (req.url.indexOf('missing') !== -1) {
              res.writeHead(404);
              res.end();
              return;
            }

            if (req.url.indexOf('mime-zip') !== -1) {
              res.setHeader('content-type', 'application/zip');
            } else if (req.url.indexOf('mime-bip') !== 1) {
              res.setHeader('content-type', 'application/bip');
            }

            serve(req, res, (0, _finalhandler.default)(req, res));
          });
          const close = server.close.bind(server);
          server.close = (0, _asyncToGenerator2.default)(function* () {
            yield _bluebird.default.delay(1000);
            return yield new _bluebird.default((resolve, reject) => {
              server.on('close', resolve);
              close(err => {
                if (err) reject(err);
              });
            });
          });
          server.listen(port);
        });
        after((0, _asyncToGenerator2.default)(function* () {
          yield server.close();
        }));
        it('should download zip file', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield _helpers.default.configureApp(`${serverUrl}/FakeIOSApp.app.zip`, '.app');
          newAppPath.should.contain('FakeIOSApp.app');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an app\n');
        }));
        it('should download zip file with query string', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield _helpers.default.configureApp(`${serverUrl}/FakeIOSApp.app.zip?sv=abc&sr=def`, '.app');
          newAppPath.should.contain('.app');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an app\n');
        }));
        it('should download an app file', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield _helpers.default.configureApp(`${serverUrl}/FakeIOSApp.app`, '.app');
          newAppPath.should.contain('.app');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an app\n');
        }));
        it('should download an apk file', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield _helpers.default.configureApp(`${serverUrl}/FakeAndroidApp.apk`, '.apk');
          newAppPath.should.contain('.apk');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an apk\n');
        }));
        it('should handle zip file that cannot be downloaded', (0, _asyncToGenerator2.default)(function* () {
          yield _helpers.default.configureApp(`${serverUrl}/missing/FakeIOSApp.app.zip`, '.app').should.eventually.be.rejectedWith(/Problem downloading app from url/);
        }));
        it('should handle invalid protocol', (0, _asyncToGenerator2.default)(function* () {
          yield _helpers.default.configureApp('file://C:/missing/FakeIOSApp.app.zip', '.app').should.eventually.be.rejectedWith(/is not supported/);
          yield _helpers.default.configureApp('ftp://localhost:8000/missing/FakeIOSApp.app.zip', '.app').should.eventually.be.rejectedWith(/is not supported/);
        }));
        it('should handle missing file in Windows path format', (0, _asyncToGenerator2.default)(function* () {
          yield _helpers.default.configureApp('C:\\missing\\FakeIOSApp.app.zip', '.app').should.eventually.be.rejectedWith(/does not exist or is not accessible/);
        }));
        it('should recognize zip mime types and unzip the downloaded file', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield _helpers.default.configureApp(`${serverUrl}/FakeAndroidApp.asd?mime-zip`, '.apk');
          newAppPath.should.contain('FakeAndroidApp.apk');
          newAppPath.should.not.contain('.asd');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an apk\n');
        }));
        it('should recognize zip mime types and unzip the downloaded file with query string', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield _helpers.default.configureApp(`${serverUrl}/FakeAndroidApp.asd?mime-zip&sv=abc&sr=def`, '.apk');
          newAppPath.should.contain('FakeAndroidApp.apk');
          newAppPath.should.not.contain('.asd');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an apk\n');
        }));
        it('should treat an unknown mime type as an app', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield _helpers.default.configureApp(`${serverUrl}/FakeAndroidApp.apk?mime-bip`, '.apk');
          newAppPath.should.contain('.apk');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an apk\n');
        }));
      });
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvYmFzZWRyaXZlci9oZWxwZXJzLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6WyJjaGFpIiwic2hvdWxkIiwidXNlIiwiY2hhaUFzUHJvbWlzZWQiLCJnZXRGaXh0dXJlIiwiZmlsZSIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZGVzY3JpYmUiLCJpdCIsIm5ld0FwcFBhdGgiLCJoIiwiY29uZmlndXJlQXBwIiwiY29udGFpbiIsImNvbnRlbnRzIiwiZnMiLCJyZWFkRmlsZSIsImVxbCIsImJlIiwicmVqZWN0ZWRXaXRoIiwicG9ydCIsInNlcnZlclVybCIsImV2ZW50dWFsbHkiLCJzZXJ2ZXIiLCJiZWZvcmUiLCJkaXIiLCJzZXJ2ZSIsImluZGV4Iiwic2V0SGVhZGVycyIsInJlcyIsInNldEhlYWRlciIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJyZXEiLCJ1cmwiLCJpbmRleE9mIiwid3JpdGVIZWFkIiwiZW5kIiwiY2xvc2UiLCJiaW5kIiwiQiIsImRlbGF5IiwicmVqZWN0Iiwib24iLCJlcnIiLCJsaXN0ZW4iLCJhZnRlciIsIm5vdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0FBLGNBQUtDLE1BQUw7O0FBQ0FELGNBQUtFLEdBQUwsQ0FBU0MsdUJBQVQ7O0FBRUEsU0FBU0MsVUFBVCxDQUFxQkMsSUFBckIsRUFBMkI7QUFDekIsU0FBT0MsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLElBQXBDLEVBQTBDLE1BQTFDLEVBQWtELFlBQWxELEVBQ2EsVUFEYixFQUN5QkgsSUFEekIsQ0FBUDtBQUVEOztBQUVESSxRQUFRLENBQUMsZ0NBQUQsRUFBbUMsWUFBWTtBQUNyREEsRUFBQUEsUUFBUSxDQUFDLGNBQUQsRUFBaUIsWUFBWTtBQUNuQ0MsSUFBQUEsRUFBRSxDQUFDLHNDQUFELGtD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VUFBQUEsVUFBVSxDQUFDVixNQUFYLENBQWtCYSxPQUFsQixDQUEwQixNQUExQjtBQUNBLGNBQUlDLFFBQVEsU0FBU0Msa0JBQUdDLFFBQUgsQ0FBWU4sVUFBWixFQUF3QixNQUF4QixDQUFyQjtBQUNBSSxVQUFBQSxRQUFRLENBQUNkLE1BQVQsQ0FBZ0JpQixHQUFoQixDQUFvQiw2QkFBcEI7QUFDRCxTQUxDLEVBQUY7QUFNRCxPQXRHTyxDQUFSO0FBdUdELEtBakhPLENBQVI7QUFrSEQsR0F2Sk8sQ0FBUjtBQXdKRCxDQXpKTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGggZnJvbSAnLi4vLi4vbGliL2Jhc2Vkcml2ZXIvaGVscGVycyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBmaW5hbGhhbmRsZXIgZnJvbSAnZmluYWxoYW5kbGVyJztcbmltcG9ydCBzZXJ2ZVN0YXRpYyBmcm9tICdzZXJ2ZS1zdGF0aWMnO1xuaW1wb3J0IGNvbnRlbnREaXNwb3NpdGlvbiBmcm9tICdjb250ZW50LWRpc3Bvc2l0aW9uJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5jaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5mdW5jdGlvbiBnZXRGaXh0dXJlIChmaWxlKSB7XG4gIHJldHVybiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nLCAndGVzdCcsICdiYXNlZHJpdmVyJyxcbiAgICAgICAgICAgICAgICAgICAgICAnZml4dHVyZXMnLCBmaWxlKTtcbn1cblxuZGVzY3JpYmUoJ2FwcCBkb3dubG9hZCBhbmQgY29uZmlndXJhdGlvbicsIGZ1bmN0aW9uICgpIHtcbiAgZGVzY3JpYmUoJ2NvbmZpZ3VyZUFwcCcsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIGdldCB0aGUgcGF0aCBmb3IgYSBsb2NhbCAuYXBwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBoLmNvbmZpZ3VyZUFwcChnZXRGaXh0dXJlKCdGYWtlSU9TQXBwLmFwcCcpLCAnLmFwcCcpO1xuICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignRmFrZUlPU0FwcC5hcHAnKTtcbiAgICAgIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKG5ld0FwcFBhdGgsICd1dGY4Jyk7XG4gICAgICBjb250ZW50cy5zaG91bGQuZXFsKCd0aGlzIGlzIG5vdCByZWFsbHkgYW4gYXBwXFxuJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBnZXQgdGhlIHBhdGggZm9yIGEgbG9jYWwgLmFwaycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgaC5jb25maWd1cmVBcHAoZ2V0Rml4dHVyZSgnRmFrZUFuZHJvaWRBcHAuYXBrJyksICcuYXBrJyk7XG4gICAgICBuZXdBcHBQYXRoLnNob3VsZC5jb250YWluKCdGYWtlQW5kcm9pZEFwcC5hcGsnKTtcbiAgICAgIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKG5ld0FwcFBhdGgsICd1dGY4Jyk7XG4gICAgICBjb250ZW50cy5zaG91bGQuZXFsKCd0aGlzIGlzIG5vdCByZWFsbHkgYW4gYXBrXFxuJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB1bnppcCBhbmQgZ2V0IHRoZSBwYXRoIGZvciBhIGxvY2FsIC5hcHAuemlwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBoLmNvbmZpZ3VyZUFwcChnZXRGaXh0dXJlKCdGYWtlSU9TQXBwLmFwcC56aXAnKSwgJy5hcHAnKTtcbiAgICAgIG5ld0FwcFBhdGguc2hvdWxkLmNvbnRhaW4oJ0Zha2VJT1NBcHAuYXBwJyk7XG4gICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgY29udGVudHMuc2hvdWxkLmVxbCgndGhpcyBpcyBub3QgcmVhbGx5IGFuIGFwcFxcbicpO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgdW56aXAgYW5kIGdldCB0aGUgcGF0aCBmb3IgYSBsb2NhbCAuaXBhJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBoLmNvbmZpZ3VyZUFwcChnZXRGaXh0dXJlKCdGYWtlSU9TQXBwLmlwYScpLCAnLmFwcCcpO1xuICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignRmFrZUlPU0FwcC5hcHAnKTtcbiAgICAgIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKG5ld0FwcFBhdGgsICd1dGY4Jyk7XG4gICAgICBjb250ZW50cy5zaG91bGQuZXFsKCd0aGlzIGlzIG5vdCByZWFsbHkgYW4gYXBwXFxuJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBmYWlsIGZvciBhIGJhZCB6aXAgZmlsZScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGF3YWl0IGguY29uZmlndXJlQXBwKGdldEZpeHR1cmUoJ0JhZFppcHBlZEFwcC56aXAnKSwgJy5hcHAnKVxuICAgICAgICAuc2hvdWxkLmJlLnJlamVjdGVkV2l0aCgnRXJyb3IgdGVzdGluZyB6aXAgYXJjaGl2ZSwgYXJlIHlvdSBzdXJlIHRoaXMgaXMgYSB6aXAgZmlsZT8nKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGZhaWwgaWYgZXh0ZW5zaW9ucyBkbyBub3QgbWF0Y2gnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBoLmNvbmZpZ3VyZUFwcChnZXRGaXh0dXJlKCdGYWtlSU9TQXBwLmFwcCcpLCAnLndyb25nJylcbiAgICAgICAgLnNob3VsZC5iZS5yZWplY3RlZFdpdGgoL2RpZCBub3QgaGF2ZSBleHRlbnNpb24gJy53cm9uZycvKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGZhaWwgaWYgemlwIGZpbGUgZG9lcyBub3QgY29udGFpbiBhbiBhcHAgd2hvc2UgZXh0ZW5zaW9uIG1hdGNoZXMnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBoLmNvbmZpZ3VyZUFwcChnZXRGaXh0dXJlKCdGYWtlSU9TQXBwLmFwcC56aXAnKSwgJy53cm9uZycpXG4gICAgICAgIC5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKC9jb3VsZCBub3QgZmluZCBhIC53cm9uZyBidW5kbGUgaW4gaXQvKTtcbiAgICB9KTtcbiAgICBkZXNjcmliZSgnc2hvdWxkIGRvd25sb2FkIGFuIGFwcCBmcm9tIHRoZSB3ZWInLCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBwb3J0ID0gODAwMDtcbiAgICAgIGNvbnN0IHNlcnZlclVybCA9IGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH1gO1xuXG4gICAgICBkZXNjcmliZSgnc2VydmVyIG5vdCBhdmFpbGFibGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIHNlcnZlciBub3QgYXZhaWxhYmxlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGF3YWl0IGguY29uZmlndXJlQXBwKGAke3NlcnZlclVybH0vRmFrZUlPU0FwcC5hcHAuemlwYCwgJy5hcHAnKVxuICAgICAgICAgICAgLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvRUNPTk5SRUZVU0VELyk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgICBkZXNjcmliZSgnc2VydmVyIGF2YWlsYWJsZScsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgLy8gdXNlIGEgbG9jYWwgc2VydmVyIHNvIHRoZXJlIGlzIG5vIGRlcGVuZGVuY3kgb24gdGhlIGludGVybmV0XG4gICAgICAgIGxldCBzZXJ2ZXI7XG4gICAgICAgIGJlZm9yZShmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgY29uc3QgZGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJywgJy4uJywgJ3Rlc3QnLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmFzZWRyaXZlcicsICdmaXh0dXJlcycpO1xuICAgICAgICAgIGNvbnN0IHNlcnZlID0gc2VydmVTdGF0aWMoZGlyLCB7XG4gICAgICAgICAgICBpbmRleDogZmFsc2UsXG4gICAgICAgICAgICBzZXRIZWFkZXJzOiAocmVzLCBwYXRoKSA9PiB7XG4gICAgICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ0NvbnRlbnQtRGlzcG9zaXRpb24nLCBjb250ZW50RGlzcG9zaXRpb24ocGF0aCkpO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHNlcnZlciA9IGh0dHAuY3JlYXRlU2VydmVyKGZ1bmN0aW9uIChyZXEsIHJlcykge1xuICAgICAgICAgICAgaWYgKHJlcS51cmwuaW5kZXhPZignbWlzc2luZycpICE9PSAtMSkge1xuICAgICAgICAgICAgICByZXMud3JpdGVIZWFkKDQwNCk7XG4gICAgICAgICAgICAgIHJlcy5lbmQoKTtcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gZm9yIHRlc3RpbmcgemlwIGZpbGUgY29udGVudCB0eXBlc1xuICAgICAgICAgICAgaWYgKHJlcS51cmwuaW5kZXhPZignbWltZS16aXAnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgcmVzLnNldEhlYWRlcignY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL3ppcCcpO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChyZXEudXJsLmluZGV4T2YoJ21pbWUtYmlwJykgIT09IDEpIHtcbiAgICAgICAgICAgICAgcmVzLnNldEhlYWRlcignY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2JpcCcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VydmUocmVxLCByZXMsIGZpbmFsaGFuZGxlcihyZXEsIHJlcykpO1xuICAgICAgICAgIH0pO1xuICAgICAgICAgIGNvbnN0IGNsb3NlID0gc2VydmVyLmNsb3NlLmJpbmQoc2VydmVyKTtcbiAgICAgICAgICBzZXJ2ZXIuY2xvc2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAvLyBwYXVzZSBhIG1vbWVudCBvciB3ZSBnZXQgRUNPTlJFU0VUIGVycm9yc1xuICAgICAgICAgICAgYXdhaXQgQi5kZWxheSgxMDAwKTtcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgIHNlcnZlci5vbignY2xvc2UnLCByZXNvbHZlKTtcbiAgICAgICAgICAgICAgY2xvc2UoKGVycikgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChlcnIpIHJlamVjdChlcnIpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfTtcbiAgICAgICAgICBzZXJ2ZXIubGlzdGVuKHBvcnQpO1xuICAgICAgICB9KTtcbiAgICAgICAgYWZ0ZXIoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGF3YWl0IHNlcnZlci5jbG9zZSgpO1xuICAgICAgICB9KTtcblxuICAgICAgICBpdCgnc2hvdWxkIGRvd25sb2FkIHppcCBmaWxlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgaC5jb25maWd1cmVBcHAoYCR7c2VydmVyVXJsfS9GYWtlSU9TQXBwLmFwcC56aXBgLCAnLmFwcCcpO1xuICAgICAgICAgIG5ld0FwcFBhdGguc2hvdWxkLmNvbnRhaW4oJ0Zha2VJT1NBcHAuYXBwJyk7XG4gICAgICAgICAgbGV0IGNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUobmV3QXBwUGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgICBjb250ZW50cy5zaG91bGQuZXFsKCd0aGlzIGlzIG5vdCByZWFsbHkgYW4gYXBwXFxuJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnc2hvdWxkIGRvd25sb2FkIHppcCBmaWxlIHdpdGggcXVlcnkgc3RyaW5nJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgaC5jb25maWd1cmVBcHAoYCR7c2VydmVyVXJsfS9GYWtlSU9TQXBwLmFwcC56aXA/c3Y9YWJjJnNyPWRlZmAsICcuYXBwJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignLmFwcCcpO1xuICAgICAgICAgIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKG5ld0FwcFBhdGgsICd1dGY4Jyk7XG4gICAgICAgICAgY29udGVudHMuc2hvdWxkLmVxbCgndGhpcyBpcyBub3QgcmVhbGx5IGFuIGFwcFxcbicpO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCBkb3dubG9hZCBhbiBhcHAgZmlsZScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsZXQgbmV3QXBwUGF0aCA9IGF3YWl0IGguY29uZmlndXJlQXBwKGAke3NlcnZlclVybH0vRmFrZUlPU0FwcC5hcHBgLCAnLmFwcCcpO1xuICAgICAgICAgIG5ld0FwcFBhdGguc2hvdWxkLmNvbnRhaW4oJy5hcHAnKTtcbiAgICAgICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcHBcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzaG91bGQgZG93bmxvYWQgYW4gYXBrIGZpbGUnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBoLmNvbmZpZ3VyZUFwcChgJHtzZXJ2ZXJVcmx9L0Zha2VBbmRyb2lkQXBwLmFwa2AsICcuYXBrJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignLmFwaycpO1xuICAgICAgICAgIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKG5ld0FwcFBhdGgsICd1dGY4Jyk7XG4gICAgICAgICAgY29udGVudHMuc2hvdWxkLmVxbCgndGhpcyBpcyBub3QgcmVhbGx5IGFuIGFwa1xcbicpO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgemlwIGZpbGUgdGhhdCBjYW5ub3QgYmUgZG93bmxvYWRlZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBhd2FpdCBoLmNvbmZpZ3VyZUFwcChgJHtzZXJ2ZXJVcmx9L21pc3NpbmcvRmFrZUlPU0FwcC5hcHAuemlwYCwgJy5hcHAnKVxuICAgICAgICAgICAgLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvUHJvYmxlbSBkb3dubG9hZGluZyBhcHAgZnJvbSB1cmwvKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIGludmFsaWQgcHJvdG9jb2wnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgYXdhaXQgaC5jb25maWd1cmVBcHAoJ2ZpbGU6Ly9DOi9taXNzaW5nL0Zha2VJT1NBcHAuYXBwLnppcCcsICcuYXBwJylcbiAgICAgICAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL2lzIG5vdCBzdXBwb3J0ZWQvKTtcbiAgICAgICAgICBhd2FpdCBoLmNvbmZpZ3VyZUFwcCgnZnRwOi8vbG9jYWxob3N0OjgwMDAvbWlzc2luZy9GYWtlSU9TQXBwLmFwcC56aXAnLCAnLmFwcCcpXG4gICAgICAgICAgICAuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9pcyBub3Qgc3VwcG9ydGVkLyk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnc2hvdWxkIGhhbmRsZSBtaXNzaW5nIGZpbGUgaW4gV2luZG93cyBwYXRoIGZvcm1hdCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBhd2FpdCBoLmNvbmZpZ3VyZUFwcCgnQzpcXFxcbWlzc2luZ1xcXFxGYWtlSU9TQXBwLmFwcC56aXAnLCAnLmFwcCcpXG4gICAgICAgICAgICAuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9kb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYWNjZXNzaWJsZS8pO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCByZWNvZ25pemUgemlwIG1pbWUgdHlwZXMgYW5kIHVuemlwIHRoZSBkb3dubG9hZGVkIGZpbGUnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBoLmNvbmZpZ3VyZUFwcChgJHtzZXJ2ZXJVcmx9L0Zha2VBbmRyb2lkQXBwLmFzZD9taW1lLXppcGAsICcuYXBrJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignRmFrZUFuZHJvaWRBcHAuYXBrJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQubm90LmNvbnRhaW4oJy5hc2QnKTtcbiAgICAgICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcGtcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzaG91bGQgcmVjb2duaXplIHppcCBtaW1lIHR5cGVzIGFuZCB1bnppcCB0aGUgZG93bmxvYWRlZCBmaWxlIHdpdGggcXVlcnkgc3RyaW5nJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgaC5jb25maWd1cmVBcHAoYCR7c2VydmVyVXJsfS9GYWtlQW5kcm9pZEFwcC5hc2Q/bWltZS16aXAmc3Y9YWJjJnNyPWRlZmAsICcuYXBrJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignRmFrZUFuZHJvaWRBcHAuYXBrJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQubm90LmNvbnRhaW4oJy5hc2QnKTtcbiAgICAgICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcGtcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzaG91bGQgdHJlYXQgYW4gdW5rbm93biBtaW1lIHR5cGUgYXMgYW4gYXBwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgaC5jb25maWd1cmVBcHAoYCR7c2VydmVyVXJsfS9GYWtlQW5kcm9pZEFwcC5hcGs/bWltZS1iaXBgLCAnLmFwaycpO1xuICAgICAgICAgIG5ld0FwcFBhdGguc2hvdWxkLmNvbnRhaW4oJy5hcGsnKTtcbiAgICAgICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcGtcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdLCJmaWxlIjoidGVzdC9iYXNlZHJpdmVyL2hlbHBlcnMtZTJlLXNwZWNzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
