"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger.js"));

var _appiumSupport = require("appium-support");

var _helpers = require("../helpers.js");

const DEFAULT_PRIVATE_KEY = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.pk8');

const DEFAULT_CERTIFICATE = _path.default.resolve(_helpers.rootDir, 'keys', 'testkey.x509.pem');

const DEFAULT_CERT_DIGEST = 'a40da80a59d170caa950cf15c18c454d47a39b26989d8b640ecd745ba71bf5dc';
const APKSIGNER_VERIFY_FAIL = 'DOES NOT VERIFY';
let apkSigningMethods = {};

function patchApksigner(_x) {
  return _patchApksigner.apply(this, arguments);
}

function _patchApksigner() {
  _patchApksigner = (0, _asyncToGenerator2.default)(function* (originalPath) {
    const originalContent = yield _appiumSupport.fs.readFile(originalPath, 'ascii');
    const patchedContent = originalContent.replace('-Djava.ext.dirs="%frameworkdir%"', '-cp "%frameworkdir%\\*"');

    if (patchedContent === originalContent) {
      return originalPath;
    }

    _logger.default.debug(`Patching '${originalPath}...`);

    const patchedPath = yield _appiumSupport.tempDir.path({
      prefix: 'apksigner',
      suffix: '.bat'
    });
    yield (0, _appiumSupport.mkdirp)(_path.default.dirname(patchedPath));
    yield _appiumSupport.fs.writeFile(patchedPath, patchedContent, 'ascii');
    return patchedPath;
  });
  return _patchApksigner.apply(this, arguments);
}

apkSigningMethods.executeApksigner = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (args = []) {
    const apkSigner = yield (0, _helpers.getApksignerForOs)(this);

    const originalFolder = _path.default.dirname(apkSigner);

    const getApksignerOutput = function () {
      var _ref2 = (0, _asyncToGenerator2.default)(function* (apksignerPath) {
        const _ref3 = yield (0, _teen_process.exec)(apksignerPath, args, {
          cwd: originalFolder
        }),
              stdout = _ref3.stdout,
              stderr = _ref3.stderr;

        var _arr = [['stdout', stdout], ['stderr', stderr]];

        for (var _i = 0; _i < _arr.length; _i++) {
          let _arr$_i = (0, _slicedToArray2.default)(_arr[_i], 2),
              name = _arr$_i[0],
              stream = _arr$_i[1];

          if (!stream) {
            continue;
          }

          if (name === 'stdout') {
            stream = stream.split('\n').filter(line => !line.includes('WARNING:')).join('\n');
          }

          _logger.default.debug(`apksigner ${name}: ${stream}`);
        }

        return stdout;
      });

      return function getApksignerOutput(_x2) {
        return _ref2.apply(this, arguments);
      };
    }();

    _logger.default.debug(`Starting '${apkSigner}' with args '${JSON.stringify(args)}'`);

    try {
      return yield getApksignerOutput(apkSigner);
    } catch (err) {
      _logger.default.warn(`Got an error during apksigner execution: ${err.message}`);

      var _arr2 = [['stdout', err.stdout], ['stderr', err.stderr]];

      for (var _i2 = 0; _i2 < _arr2.length; _i2++) {
        const _arr2$_i = (0, _slicedToArray2.default)(_arr2[_i2], 2),
              name = _arr2$_i[0],
              stream = _arr2$_i[1];

        if (stream) {
          _logger.default.warn(`apksigner ${name}: ${stream}`);
        }
      }

      if (_appiumSupport.system.isWindows()) {
        const patchedApksigner = yield patchApksigner(apkSigner);

        if (patchedApksigner !== apkSigner) {
          try {
            return yield getApksignerOutput(patchedApksigner);
          } finally {
            yield _appiumSupport.fs.unlink(patchedApksigner);
          }
        }
      }

      throw err;
    }
  });

  return function () {
    return _ref.apply(this, arguments);
  };
}();

apkSigningMethods.signWithDefaultCert = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (apk) {
    _logger.default.debug(`Signing '${apk}' with default cert`);

    if (!(yield _appiumSupport.fs.exists(apk))) {
      throw new Error(`${apk} file doesn't exist.`);
    }

    try {
      const args = ['sign', '--key', DEFAULT_PRIVATE_KEY, '--cert', DEFAULT_CERTIFICATE, apk];
      yield this.executeApksigner(args);
    } catch (err) {
      _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to sign.jar. ` + `Original error: ${err.message}` + (err.stderr ? `; StdErr: ${err.stderr}` : ''));

      const java = (0, _helpers.getJavaForOs)();

      const signPath = _path.default.resolve(this.helperJarPath, 'sign.jar');

      _logger.default.debug("Resigning apk.");

      try {
        yield (0, _teen_process.exec)(java, ['-jar', signPath, apk, '--override']);
      } catch (e) {
        throw new Error(`Could not sign with default certificate. Original error ${e.message}`);
      }
    }
  });

  return function (_x3) {
    return _ref4.apply(this, arguments);
  };
}();

apkSigningMethods.signWithCustomCert = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (apk) {
    _logger.default.debug(`Signing '${apk}' with custom cert`);

    if (!(yield _appiumSupport.fs.exists(this.keystorePath))) {
      throw new Error(`Keystore: ${this.keystorePath} doesn't exist.`);
    }

    if (!(yield _appiumSupport.fs.exists(apk))) {
      throw new Error(`'${apk}' doesn't exist.`);
    }

    try {
      const args = ['sign', '--ks', this.keystorePath, '--ks-key-alias', this.keyAlias, '--ks-pass', `pass:${this.keystorePassword}`, '--key-pass', `pass:${this.keyPassword}`, apk];
      yield this.executeApksigner(args);
    } catch (err) {
      _logger.default.warn(`Cannot use apksigner tool for signing. Defaulting to jarsigner. ` + `Original error: ${err.message}`);

      try {
        _logger.default.debug("Unsigning apk.");

        yield (0, _teen_process.exec)((0, _helpers.getJavaForOs)(), ['-jar', _path.default.resolve(this.helperJarPath, 'unsign.jar'), apk]);

        _logger.default.debug("Signing apk.");

        const jarsigner = _path.default.resolve((0, _helpers.getJavaHome)(), 'bin', `jarsigner${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

        yield (0, _teen_process.exec)(jarsigner, ['-sigalg', 'MD5withRSA', '-digestalg', 'SHA1', '-keystore', this.keystorePath, '-storepass', this.keystorePassword, '-keypass', this.keyPassword, apk, this.keyAlias]);
      } catch (e) {
        throw new Error(`Could not sign with custom certificate. Original error ${e.message}`);
      }
    }
  });

  return function (_x4) {
    return _ref5.apply(this, arguments);
  };
}();

apkSigningMethods.sign = function () {
  var _ref6 = (0, _asyncToGenerator2.default)(function* (apk) {
    let apksignerFound = true;

    try {
      yield (0, _helpers.getApksignerForOs)(this);
    } catch (err) {
      apksignerFound = false;
    }

    if (apksignerFound) {
      yield this.zipAlignApk(apk);
    }

    if (this.useKeystore) {
      yield this.signWithCustomCert(apk);
    } else {
      yield this.signWithDefaultCert(apk);
    }

    if (!apksignerFound) {
      yield this.zipAlignApk(apk);
    }
  });

  return function (_x5) {
    return _ref6.apply(this, arguments);
  };
}();

apkSigningMethods.zipAlignApk = function () {
  var _ref7 = (0, _asyncToGenerator2.default)(function* (apk) {
    yield this.initZipAlign();

    try {
      yield (0, _teen_process.exec)(this.binaries.zipalign, ['-c', '4', apk]);

      _logger.default.debug(`${apk}' is already zip-aligned. Doing nothing`);

      return false;
    } catch (e) {
      _logger.default.debug(`'${apk}' is not zip-aligned. Aligning`);
    }

    const alignedApk = yield _appiumSupport.tempDir.path({
      prefix: 'appium',
      suffix: '.tmp'
    });
    yield (0, _appiumSupport.mkdirp)(_path.default.dirname(alignedApk));

    try {
      yield (0, _teen_process.exec)(this.binaries.zipalign, ['-f', '4', apk, alignedApk]);
      yield _appiumSupport.fs.mv(alignedApk, apk, {
        mkdirp: true
      });
      return true;
    } catch (e) {
      if (yield _appiumSupport.fs.exists(alignedApk)) {
        yield _appiumSupport.fs.unlink(alignedApk);
      }

      throw new Error(`zipAlignApk failed. Original error: ${e.message}. Stdout: '${e.stdout}'; Stderr: '${e.stderr}'`);
    }
  });

  return function (_x6) {
    return _ref7.apply(this, arguments);
  };
}();

apkSigningMethods.checkApkCert = function () {
  var _ref8 = (0, _asyncToGenerator2.default)(function* (apk, pkg) {
    _logger.default.debug(`Checking app cert for ${apk}`);

    if (!(yield _appiumSupport.fs.exists(apk))) {
      _logger.default.debug(`'${apk}' does not exist`);

      return false;
    }

    if (this.useKeystore) {
      return yield this.checkCustomApkCert(apk, pkg);
    }

    try {
      yield (0, _helpers.getApksignerForOs)(this);
      const output = yield this.executeApksigner(['verify', '--print-certs', apk]);

      if (!_lodash.default.includes(output, DEFAULT_CERT_DIGEST)) {
        _logger.default.debug(`'${apk}' is signed with non-default certificate`);

        return false;
      }

      _logger.default.debug(`'${apk}' is already signed.`);

      return true;
    } catch (err) {
      if (err.stderr && err.stderr.includes(APKSIGNER_VERIFY_FAIL)) {
        _logger.default.debug(`'${apk}' is not signed with debug cert`);

        return false;
      }

      _logger.default.warn(`Cannot use apksigner tool for signature verification. ` + `Original error: ${err.message}`);
    }

    try {
      _logger.default.debug(`Defaulting to verify.jar`);

      const java = (0, _helpers.getJavaForOs)();
      yield (0, _teen_process.exec)(java, ['-jar', _path.default.resolve(this.helperJarPath, 'verify.jar'), apk]);

      _logger.default.debug(`'${apk}' is already signed.`);

      return true;
    } catch (err) {
      _logger.default.debug(`'${apk}' is not signed with debug cert${err.stderr ? `: ${err.stderr}` : ''}`);

      return false;
    }
  });

  return function (_x7, _x8) {
    return _ref8.apply(this, arguments);
  };
}();

apkSigningMethods.checkCustomApkCert = function () {
  var _ref9 = (0, _asyncToGenerator2.default)(function* (apk, pkg) {
    _logger.default.debug(`Checking custom app cert for ${apk}`);

    let h = "a-fA-F0-9";
    let md5Str = [`.*MD5.*((?:[${h}]{2}:){15}[${h}]{2})`];
    let md5 = new RegExp(md5Str, 'mi');
    let javaHome = (0, _helpers.getJavaHome)();

    let keytool = _path.default.resolve(javaHome, 'bin', `keytool${_appiumSupport.system.isWindows() ? '.exe' : ''}`);

    let keystoreHash = yield this.getKeystoreMd5(keytool, md5);
    return yield this.checkApkKeystoreMatch(keytool, md5, keystoreHash, pkg, apk);
  });

  return function (_x9, _x10) {
    return _ref9.apply(this, arguments);
  };
}();

apkSigningMethods.getKeystoreMd5 = function () {
  var _ref10 = (0, _asyncToGenerator2.default)(function* (keytool, md5re) {
    _logger.default.debug("Printing keystore md5.");

    try {
      let _ref11 = yield (0, _teen_process.exec)(keytool, ['-v', '-list', '-alias', this.keyAlias, '-keystore', this.keystorePath, '-storepass', this.keystorePassword]),
          stdout = _ref11.stdout;

      let keystoreHash = md5re.exec(stdout);
      keystoreHash = keystoreHash ? keystoreHash[1] : null;

      _logger.default.debug(`Keystore MD5: ${keystoreHash}`);

      return keystoreHash;
    } catch (e) {
      throw new Error(`getKeystoreMd5 failed. Original error: ${e.message}`);
    }
  });

  return function (_x11, _x12) {
    return _ref10.apply(this, arguments);
  };
}();

apkSigningMethods.checkApkKeystoreMatch = function () {
  var _ref12 = (0, _asyncToGenerator2.default)(function* (keytool, md5re, keystoreHash, pkg, apk) {
    var _this = this;

    let entryHash = null;
    let rsa = /^META-INF\/.*\.[rR][sS][aA]$/;
    let foundKeystoreMatch = false;
    yield _appiumSupport.zip.readEntries(apk, function () {
      var _ref13 = (0, _asyncToGenerator2.default)(function* ({
        entry,
        extractEntryTo
      }) {
        entry = entry.fileName;

        if (!rsa.test(entry)) {
          return;
        }

        _logger.default.debug(`Entry: ${entry}`);

        let entryPath = _path.default.join(_this.tmpDir, pkg, 'cert');

        _logger.default.debug(`entryPath: ${entryPath}`);

        let entryFile = _path.default.join(entryPath, entry);

        _logger.default.debug(`entryFile: ${entryFile}`);

        yield _appiumSupport.fs.rimraf(entryPath);
        yield extractEntryTo(entryPath);

        _logger.default.debug("extracted!");

        _logger.default.debug("Printing apk md5.");

        let _ref14 = yield (0, _teen_process.exec)(keytool, ['-v', '-printcert', '-file', entryFile]),
            stdout = _ref14.stdout;

        entryHash = md5re.exec(stdout);
        entryHash = entryHash ? entryHash[1] : null;

        _logger.default.debug(`entryHash MD5: ${entryHash}`);

        _logger.default.debug(`keystore MD5: ${keystoreHash}`);

        let matchesKeystore = entryHash && entryHash === keystoreHash;

        _logger.default.debug(`Matches keystore? ${matchesKeystore}`);

        if (matchesKeystore) {
          foundKeystoreMatch = true;
          return false;
        }
      });

      return function (_x18) {
        return _ref13.apply(this, arguments);
      };
    }());
    return foundKeystoreMatch;
  });

  return function (_x13, _x14, _x15, _x16, _x17) {
    return _ref12.apply(this, arguments);
  };
}();

var _default = apkSigningMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi90b29scy9hcGstc2lnbmluZy5qcyJdLCJuYW1lcyI6WyJERUZBVUxUX1BSSVZBVEVfS0VZIiwicGF0aCIsInJlc29sdmUiLCJyb290RGlyIiwiREVGQVVMVF9DRVJUSUZJQ0FURSIsIkRFRkFVTFRfQ0VSVF9ESUdFU1QiLCJBUEtTSUdORVJfVkVSSUZZX0ZBSUwiLCJhcGtTaWduaW5nTWV0aG9kcyIsInBhdGNoQXBrc2lnbmVyIiwib3JpZ2luYWxQYXRoIiwib3JpZ2luYWxDb250ZW50IiwiZnMiLCJyZWFkRmlsZSIsInBhdGNoZWRDb250ZW50IiwicmVwbGFjZSIsImxvZyIsImRlYnVnIiwicGF0Y2hlZFBhdGgiLCJ0ZW1wRGlyIiwicHJlZml4Iiwic3VmZml4IiwiZGlybmFtZSIsIndyaXRlRmlsZSIsImV4ZWN1dGVBcGtzaWduZXIiLCJhcmdzIiwiYXBrU2lnbmVyIiwib3JpZ2luYWxGb2xkZXIiLCJnZXRBcGtzaWduZXJPdXRwdXQiLCJhcGtzaWduZXJQYXRoIiwiY3dkIiwic3Rkb3V0Iiwic3RkZXJyIiwibmFtZSIsInN0cmVhbSIsInNwbGl0IiwiZmlsdGVyIiwibGluZSIsImluY2x1ZGVzIiwiam9pbiIsIkpTT04iLCJzdHJpbmdpZnkiLCJlcnIiLCJ3YXJuIiwibWVzc2FnZSIsInN5c3RlbSIsImlzV2luZG93cyIsInBhdGNoZWRBcGtzaWduZXIiLCJ1bmxpbmsiLCJzaWduV2l0aERlZmF1bHRDZXJ0IiwiYXBrIiwiZXhpc3RzIiwiRXJyb3IiLCJqYXZhIiwic2lnblBhdGgiLCJoZWxwZXJKYXJQYXRoIiwiZSIsInNpZ25XaXRoQ3VzdG9tQ2VydCIsImtleXN0b3JlUGF0aCIsImtleUFsaWFzIiwia2V5c3RvcmVQYXNzd29yZCIsImtleVBhc3N3b3JkIiwiamFyc2lnbmVyIiwic2lnbiIsImFwa3NpZ25lckZvdW5kIiwiemlwQWxpZ25BcGsiLCJ1c2VLZXlzdG9yZSIsImluaXRaaXBBbGlnbiIsImJpbmFyaWVzIiwiemlwYWxpZ24iLCJhbGlnbmVkQXBrIiwibXYiLCJta2RpcnAiLCJjaGVja0Fwa0NlcnQiLCJwa2ciLCJjaGVja0N1c3RvbUFwa0NlcnQiLCJvdXRwdXQiLCJfIiwiaCIsIm1kNVN0ciIsIm1kNSIsIlJlZ0V4cCIsImphdmFIb21lIiwia2V5dG9vbCIsImtleXN0b3JlSGFzaCIsImdldEtleXN0b3JlTWQ1IiwiY2hlY2tBcGtLZXlzdG9yZU1hdGNoIiwibWQ1cmUiLCJleGVjIiwiZW50cnlIYXNoIiwicnNhIiwiZm91bmRLZXlzdG9yZU1hdGNoIiwiemlwIiwicmVhZEVudHJpZXMiLCJlbnRyeSIsImV4dHJhY3RFbnRyeVRvIiwiZmlsZU5hbWUiLCJ0ZXN0IiwiZW50cnlQYXRoIiwidG1wRGlyIiwiZW50cnlGaWxlIiwicmltcmFmIiwibWF0Y2hlc0tleXN0b3JlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsbUJBQW1CLEdBQUdDLGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsYUFBOUIsQ0FBNUI7O0FBQ0EsTUFBTUMsbUJBQW1CLEdBQUdILGNBQUtDLE9BQUwsQ0FBYUMsZ0JBQWIsRUFBc0IsTUFBdEIsRUFBOEIsa0JBQTlCLENBQTVCOztBQUNBLE1BQU1FLG1CQUFtQixHQUFHLGtFQUE1QjtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLGlCQUE5QjtBQUVBLElBQUlDLGlCQUFpQixHQUFHLEVBQXhCOztTQVVlQyxjOzs7OztvREFBZixXQUErQkMsWUFBL0IsRUFBNkM7QUFDM0MsVUFBTUMsZUFBZSxTQUFTQyxrQkFBR0MsUUFBSCxDQUFZSCxZQUFaLEVBQTBCLE9BQTFCLENBQTlCO0FBQ0EsVUFBTUksY0FBYyxHQUFHSCxlQUFlLENBQUNJLE9BQWhCLENBQXdCLGtDQUF4QixFQUNyQix5QkFEcUIsQ0FBdkI7O0FBRUEsUUFBSUQsY0FBYyxLQUFLSCxlQUF2QixFQUF3QztBQUN0QyxhQUFPRCxZQUFQO0FBQ0Q7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Q0FBQyxJQUFELEVBQU8sWUFBUCxFQUFxQixPQUFyQixFQUE4QmlCLFNBQTlCLENBQWQsQ0FqQnVDO0FBQUEsWUFpQnZEckUsTUFqQnVELFVBaUJ2REEsTUFqQnVEOztBQWtCNUQwRCxRQUFBQSxTQUFTLEdBQUdGLEtBQUssQ0FBQ0MsSUFBTixDQUFXekQsTUFBWCxDQUFaO0FBQ0EwRCxRQUFBQSxTQUFTLEdBQUdBLFNBQVMsR0FBR0EsU0FBUyxDQUFDLENBQUQsQ0FBWixHQUFrQixJQUF2Qzs7QUFDQXpFLHdCQUFJQyxLQUFKLENBQVcsa0JBQWlCd0UsU0FBVSxFQUF0Qzs7QUFDQXpFLHdCQUFJQyxLQUFKLENBQVcsaUJBQWdCbUUsWUFBYSxFQUF4Qzs7QUFDQSxZQUFJa0IsZUFBZSxHQUFHYixTQUFTLElBQUlBLFNBQVMsS0FBS0wsWUFBakQ7O0FBQ0FwRSx3QkFBSUMsS0FBSixDQUFXLHFCQUFvQnFGLGVBQWdCLEVBQS9DOztBQUdBLFlBQUlBLGVBQUosRUFBcUI7QUFDbkJYLFVBQUFBLGtCQUFrQixHQUFHLElBQXJCO0FBQ0EsaUJBQU8sS0FBUDtBQUNEO0FBQ0YsT0E5Qks7O0FBQUE7QUFBQTtBQUFBO0FBQUEsUUFBTjtBQStCQSxXQUFPQSxrQkFBUDtBQUNELEdBdENEOztBQUFBO0FBQUE7QUFBQTtBQUFBOztlQXdDZW5GLGlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlci5qcyc7XG5pbXBvcnQgeyB0ZW1wRGlyLCBzeXN0ZW0sIG1rZGlycCwgZnMsIHppcCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGdldEphdmFGb3JPcywgZ2V0QXBrc2lnbmVyRm9yT3MsIGdldEphdmFIb21lLCByb290RGlyIH0gZnJvbSAnLi4vaGVscGVycy5qcyc7XG5cbmNvbnN0IERFRkFVTFRfUFJJVkFURV9LRVkgPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ2tleXMnLCAndGVzdGtleS5wazgnKTtcbmNvbnN0IERFRkFVTFRfQ0VSVElGSUNBVEUgPSBwYXRoLnJlc29sdmUocm9vdERpciwgJ2tleXMnLCAndGVzdGtleS54NTA5LnBlbScpO1xuY29uc3QgREVGQVVMVF9DRVJUX0RJR0VTVCA9ICdhNDBkYTgwYTU5ZDE3MGNhYTk1MGNmMTVjMThjNDU0ZDQ3YTM5YjI2OTg5ZDhiNjQwZWNkNzQ1YmE3MWJmNWRjJztcbmNvbnN0IEFQS1NJR05FUl9WRVJJRllfRkFJTCA9ICdET0VTIE5PVCBWRVJJRlknO1xuXG5sZXQgYXBrU2lnbmluZ01ldGhvZHMgPSB7fTtcblxuLyoqXG4gKiBBcHBsaWVzIHRoZSBwYXRjaCwgd2hpY2ggd29ya2Fyb3VuZHMnLURqYXZhLmV4dC5kaXJzIGlzIG5vdCBzdXBwb3J0ZWQuIFVzZSAtY2xhc3NwYXRoIGluc3RlYWQuJ1xuICogZXJyb3Igb24gV2luZG93cyBieSBjcmVhdGluZyBhIHRlbXBvcmFyeSBwYXRjaGVkIGNvcHkgb2YgdGhlIG9yaWdpbmFsIGFwa3NpZ25lciBzY3JpcHQuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IG9yaWdpbmFsUGF0aCAtIFRoZSBvcmlnaW5hbCBwYXRoIHRvIGFwa3NpZ25lciB0b29sXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBwYXRjaGVkIHNjcmlwdCBvciB0aGUgc2FtZSBwYXRoIGlmIHRoZXJlIGlzXG4gKiAgICAgICAgICAgICAgICAgICBubyBuZWVkIHRvIHBhdGNoIHRoZSBvcmlnaW5hbCBmaWxlLlxuICovXG5hc3luYyBmdW5jdGlvbiBwYXRjaEFwa3NpZ25lciAob3JpZ2luYWxQYXRoKSB7XG4gIGNvbnN0IG9yaWdpbmFsQ29udGVudCA9IGF3YWl0IGZzLnJlYWRGaWxlKG9yaWdpbmFsUGF0aCwgJ2FzY2lpJyk7XG4gIGNvbnN0IHBhdGNoZWRDb250ZW50ID0gb3JpZ2luYWxDb250ZW50LnJlcGxhY2UoJy1EamF2YS5leHQuZGlycz1cIiVmcmFtZXdvcmtkaXIlXCInLFxuICAgICctY3AgXCIlZnJhbWV3b3JrZGlyJVxcXFwqXCInKTtcbiAgaWYgKHBhdGNoZWRDb250ZW50ID09PSBvcmlnaW5hbENvbnRlbnQpIHtcbiAgICByZXR1cm4gb3JpZ2luYWxQYXRoO1xuICB9XG4gIGxvZy5kZWJ1ZyhgUGF0Y2hpbmcgJyR7b3JpZ2luYWxQYXRofS4uLmApO1xuICBjb25zdCBwYXRjaGVkUGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7cHJlZml4OiAnYXBrc2lnbmVyJywgc3VmZml4OiAnLmJhdCd9KTtcbiAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShwYXRjaGVkUGF0aCkpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUocGF0Y2hlZFBhdGgsIHBhdGNoZWRDb250ZW50LCAnYXNjaWknKTtcbiAgcmV0dXJuIHBhdGNoZWRQYXRoO1xufVxuXG4vKipcbiAqIEV4ZWN1dGUgYXBrc2lnbmVyIHV0aWxpdHkgd2l0aCBnaXZlbiBhcmd1bWVudHMuXG4gKlxuICogQHBhcmFtIHs/QXJyYXk8U3RyaW5nPn0gYXJncyAtIFRoZSBsaXN0IG9mIHRvb2wgYXJndW1lbnRzLlxuICogQHJldHVybiB7c3RyaW5nfSAtIENvbW1hbmQgc3Rkb3V0XG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgYXBrc2lnbmVyIGJpbmFyeSBpcyBub3QgcHJlc2VudCBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW1cbiAqICAgICAgICAgICAgICAgICBvciB0aGUgcmV0dXJuIGNvZGUgaXMgbm90IGVxdWFsIHRvIHplcm8uXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLmV4ZWN1dGVBcGtzaWduZXIgPSBhc3luYyBmdW5jdGlvbiAoYXJncyA9IFtdKSB7XG4gIGNvbnN0IGFwa1NpZ25lciA9IGF3YWl0IGdldEFwa3NpZ25lckZvck9zKHRoaXMpO1xuICBjb25zdCBvcmlnaW5hbEZvbGRlciA9IHBhdGguZGlybmFtZShhcGtTaWduZXIpO1xuICBjb25zdCBnZXRBcGtzaWduZXJPdXRwdXQgPSBhc3luYyAoYXBrc2lnbmVyUGF0aCkgPT4ge1xuICAgIGNvbnN0IHtzdGRvdXQsIHN0ZGVycn0gPSBhd2FpdCBleGVjKGFwa3NpZ25lclBhdGgsIGFyZ3MsIHtcbiAgICAgIGN3ZDogb3JpZ2luYWxGb2xkZXIsXG4gICAgfSk7XG4gICAgZm9yIChsZXQgW25hbWUsIHN0cmVhbV0gb2YgW1snc3Rkb3V0Jywgc3Rkb3V0XSwgWydzdGRlcnInLCBzdGRlcnJdXSkge1xuICAgICAgaWYgKCFzdHJlYW0pIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmIChuYW1lID09PSAnc3Rkb3V0Jykge1xuICAgICAgICAvLyBNYWtlIHRoZSBvdXRwdXQgbGVzcyB0YWxrYXRpdmVcbiAgICAgICAgc3RyZWFtID0gc3RyZWFtLnNwbGl0KCdcXG4nKVxuICAgICAgICAgIC5maWx0ZXIoKGxpbmUpID0+ICFsaW5lLmluY2x1ZGVzKCdXQVJOSU5HOicpKVxuICAgICAgICAgIC5qb2luKCdcXG4nKTtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgYXBrc2lnbmVyICR7bmFtZX06ICR7c3RyZWFtfWApO1xuICAgIH1cbiAgICByZXR1cm4gc3Rkb3V0O1xuICB9O1xuICBsb2cuZGVidWcoYFN0YXJ0aW5nICcke2Fwa1NpZ25lcn0nIHdpdGggYXJncyAnJHtKU09OLnN0cmluZ2lmeShhcmdzKX0nYCk7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IGdldEFwa3NpZ25lck91dHB1dChhcGtTaWduZXIpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgR290IGFuIGVycm9yIGR1cmluZyBhcGtzaWduZXIgZXhlY3V0aW9uOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIGZvciAoY29uc3QgW25hbWUsIHN0cmVhbV0gb2YgW1snc3Rkb3V0JywgZXJyLnN0ZG91dF0sIFsnc3RkZXJyJywgZXJyLnN0ZGVycl1dKSB7XG4gICAgICBpZiAoc3RyZWFtKSB7XG4gICAgICAgIGxvZy53YXJuKGBhcGtzaWduZXIgJHtuYW1lfTogJHtzdHJlYW19YCk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICAgIGNvbnN0IHBhdGNoZWRBcGtzaWduZXIgPSBhd2FpdCBwYXRjaEFwa3NpZ25lcihhcGtTaWduZXIpO1xuICAgICAgaWYgKHBhdGNoZWRBcGtzaWduZXIgIT09IGFwa1NpZ25lcikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJldHVybiBhd2FpdCBnZXRBcGtzaWduZXJPdXRwdXQocGF0Y2hlZEFwa3NpZ25lcik7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgYXdhaXQgZnMudW5saW5rKHBhdGNoZWRBcGtzaWduZXIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuLyoqXG4gKiAoUmUpc2lnbiB0aGUgZ2l2ZW4gYXBrIGZpbGUgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtIHdpdGggdGhlIGRlZmF1bHQgY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNpZ25pbmcgZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnNpZ25XaXRoRGVmYXVsdENlcnQgPSBhc3luYyBmdW5jdGlvbiAoYXBrKSB7XG4gIGxvZy5kZWJ1ZyhgU2lnbmluZyAnJHthcGt9JyB3aXRoIGRlZmF1bHQgY2VydGApO1xuICBpZiAoIShhd2FpdCBmcy5leGlzdHMoYXBrKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCR7YXBrfSBmaWxlIGRvZXNuJ3QgZXhpc3QuYCk7XG4gIH1cblxuICB0cnkge1xuICAgIGNvbnN0IGFyZ3MgPSBbJ3NpZ24nLFxuICAgICAgJy0ta2V5JywgREVGQVVMVF9QUklWQVRFX0tFWSxcbiAgICAgICctLWNlcnQnLCBERUZBVUxUX0NFUlRJRklDQVRFLFxuICAgICAgYXBrXTtcbiAgICBhd2FpdCB0aGlzLmV4ZWN1dGVBcGtzaWduZXIoYXJncyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBDYW5ub3QgdXNlIGFwa3NpZ25lciB0b29sIGZvciBzaWduaW5nLiBEZWZhdWx0aW5nIHRvIHNpZ24uamFyLiBgICtcbiAgICAgICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCArIChlcnIuc3RkZXJyID8gYDsgU3RkRXJyOiAke2Vyci5zdGRlcnJ9YCA6ICcnKSk7XG4gICAgY29uc3QgamF2YSA9IGdldEphdmFGb3JPcygpO1xuICAgIGNvbnN0IHNpZ25QYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuaGVscGVySmFyUGF0aCwgJ3NpZ24uamFyJyk7XG4gICAgbG9nLmRlYnVnKFwiUmVzaWduaW5nIGFway5cIik7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoamF2YSwgWyctamFyJywgc2lnblBhdGgsIGFwaywgJy0tb3ZlcnJpZGUnXSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3Qgc2lnbiB3aXRoIGRlZmF1bHQgY2VydGlmaWNhdGUuIE9yaWdpbmFsIGVycm9yICR7ZS5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxufTtcblxuLyoqXG4gKiAoUmUpc2lnbiB0aGUgZ2l2ZW4gYXBrIGZpbGUgb24gdGhlIGxvY2FsIGZpbGUgc3lzdGVtIHdpdGggYSBjdXN0b20gY2VydGlmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNpZ25pbmcgZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnNpZ25XaXRoQ3VzdG9tQ2VydCA9IGFzeW5jIGZ1bmN0aW9uIChhcGspIHtcbiAgbG9nLmRlYnVnKGBTaWduaW5nICcke2Fwa30nIHdpdGggY3VzdG9tIGNlcnRgKTtcbiAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMua2V5c3RvcmVQYXRoKSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEtleXN0b3JlOiAke3RoaXMua2V5c3RvcmVQYXRofSBkb2Vzbid0IGV4aXN0LmApO1xuICB9XG4gIGlmICghKGF3YWl0IGZzLmV4aXN0cyhhcGspKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJyR7YXBrfScgZG9lc24ndCBleGlzdC5gKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgY29uc3QgYXJncyA9IFsnc2lnbicsXG4gICAgICAnLS1rcycsIHRoaXMua2V5c3RvcmVQYXRoLFxuICAgICAgJy0ta3Mta2V5LWFsaWFzJywgdGhpcy5rZXlBbGlhcyxcbiAgICAgICctLWtzLXBhc3MnLCBgcGFzczoke3RoaXMua2V5c3RvcmVQYXNzd29yZH1gLFxuICAgICAgJy0ta2V5LXBhc3MnLCBgcGFzczoke3RoaXMua2V5UGFzc3dvcmR9YCxcbiAgICAgIGFwa107XG4gICAgYXdhaXQgdGhpcy5leGVjdXRlQXBrc2lnbmVyKGFyZ3MpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgQ2Fubm90IHVzZSBhcGtzaWduZXIgdG9vbCBmb3Igc2lnbmluZy4gRGVmYXVsdGluZyB0byBqYXJzaWduZXIuIGAgK1xuICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB0cnkge1xuICAgICAgbG9nLmRlYnVnKFwiVW5zaWduaW5nIGFway5cIik7XG4gICAgICBhd2FpdCBleGVjKGdldEphdmFGb3JPcygpLCBbJy1qYXInLCBwYXRoLnJlc29sdmUodGhpcy5oZWxwZXJKYXJQYXRoLCAndW5zaWduLmphcicpLCBhcGtdKTtcbiAgICAgIGxvZy5kZWJ1ZyhcIlNpZ25pbmcgYXBrLlwiKTtcbiAgICAgIGNvbnN0IGphcnNpZ25lciA9IHBhdGgucmVzb2x2ZShnZXRKYXZhSG9tZSgpLCAnYmluJywgYGphcnNpZ25lciR7c3lzdGVtLmlzV2luZG93cygpID8gJy5leGUnIDogJyd9YCk7XG4gICAgICBhd2FpdCBleGVjKGphcnNpZ25lciwgWyctc2lnYWxnJywgJ01ENXdpdGhSU0EnLCAnLWRpZ2VzdGFsZycsICdTSEExJyxcbiAgICAgICAgJy1rZXlzdG9yZScsIHRoaXMua2V5c3RvcmVQYXRoLCAnLXN0b3JlcGFzcycsIHRoaXMua2V5c3RvcmVQYXNzd29yZCxcbiAgICAgICAgJy1rZXlwYXNzJywgdGhpcy5rZXlQYXNzd29yZCwgYXBrLCB0aGlzLmtleUFsaWFzXSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3Qgc2lnbiB3aXRoIGN1c3RvbSBjZXJ0aWZpY2F0ZS4gT3JpZ2luYWwgZXJyb3IgJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG59O1xuXG4vKipcbiAqIChSZSlzaWduIHRoZSBnaXZlbiBhcGsgZmlsZSBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0gd2l0aCBlaXRoZXJcbiAqIGN1c3RvbSBvciBkZWZhdWx0IGNlcnRpZmljYXRlIGJhc2VkIG9uIF90aGlzLnVzZUtleXN0b3JlXyBwcm9wZXJ0eSB2YWx1ZVxuICogYW5kIFppcC1hbGlnbnMgaXQgYWZ0ZXIgc2lnbmluZy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgc2lnbmluZyBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuc2lnbiA9IGFzeW5jIGZ1bmN0aW9uIChhcGspIHtcbiAgbGV0IGFwa3NpZ25lckZvdW5kID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBnZXRBcGtzaWduZXJGb3JPcyh0aGlzKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgYXBrc2lnbmVyRm91bmQgPSBmYWxzZTtcbiAgfVxuXG4gIGlmIChhcGtzaWduZXJGb3VuZCkge1xuICAgIC8vIGl0IGlzIG5lY2Vzc2FyeSB0byBhcHBseSB6aXBhbGlnbiBvbmx5IGJlZm9yZSBzaWduaW5nXG4gICAgLy8gaWYgYXBrc2lnbmVyIGlzIHVzZWQgb3Igb25seSBhZnRlciBzaWduaW5nIGlmIHdlIG9ubHkgaGF2ZVxuICAgIC8vIHNpZ24uamFyIHV0aWxpdHlcbiAgICBhd2FpdCB0aGlzLnppcEFsaWduQXBrKGFwayk7XG4gIH1cblxuICBpZiAodGhpcy51c2VLZXlzdG9yZSkge1xuICAgIGF3YWl0IHRoaXMuc2lnbldpdGhDdXN0b21DZXJ0KGFwayk7XG4gIH0gZWxzZSB7XG4gICAgYXdhaXQgdGhpcy5zaWduV2l0aERlZmF1bHRDZXJ0KGFwayk7XG4gIH1cblxuICBpZiAoIWFwa3NpZ25lckZvdW5kKSB7XG4gICAgYXdhaXQgdGhpcy56aXBBbGlnbkFwayhhcGspO1xuICB9XG59O1xuXG4vKipcbiAqIFBlcmZvcm0gemlwLWFsaWduaW5nIHRvIHRoZSBnaXZlbiBsb2NhbCBhcGsgZmlsZS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBrIC0gVGhlIGZ1bGwgcGF0aCB0byB0aGUgbG9jYWwgYXBrIGZpbGUuXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgYXBrIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBhbGlnbmVkXG4gKiBvciBmYWxzZSBpZiB0aGUgYXBrIGhhcyBiZWVuIGFscmVhZHkgYWxpZ25lZC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB6aXAtYWxpZ24gZmFpbHMuXG4gKi9cbmFwa1NpZ25pbmdNZXRob2RzLnppcEFsaWduQXBrID0gYXN5bmMgZnVuY3Rpb24gKGFwaykge1xuICBhd2FpdCB0aGlzLmluaXRaaXBBbGlnbigpO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWModGhpcy5iaW5hcmllcy56aXBhbGlnbiwgWyctYycsICc0JywgYXBrXSk7XG4gICAgbG9nLmRlYnVnKGAke2Fwa30nIGlzIGFscmVhZHkgemlwLWFsaWduZWQuIERvaW5nIG5vdGhpbmdgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZGVidWcoYCcke2Fwa30nIGlzIG5vdCB6aXAtYWxpZ25lZC4gQWxpZ25pbmdgKTtcbiAgfVxuICBjb25zdCBhbGlnbmVkQXBrID0gYXdhaXQgdGVtcERpci5wYXRoKHtwcmVmaXg6ICdhcHBpdW0nLCBzdWZmaXg6ICcudG1wJ30pO1xuICBhd2FpdCBta2RpcnAocGF0aC5kaXJuYW1lKGFsaWduZWRBcGspKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCBleGVjKHRoaXMuYmluYXJpZXMuemlwYWxpZ24sIFsnLWYnLCAnNCcsIGFwaywgYWxpZ25lZEFwa10pO1xuICAgIGF3YWl0IGZzLm12KGFsaWduZWRBcGssIGFwaywgeyBta2RpcnA6IHRydWUgfSk7XG4gICAgcmV0dXJuIHRydWU7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoYXdhaXQgZnMuZXhpc3RzKGFsaWduZWRBcGspKSB7XG4gICAgICBhd2FpdCBmcy51bmxpbmsoYWxpZ25lZEFwayk7XG4gICAgfVxuICAgIHRocm93IG5ldyBFcnJvcihgemlwQWxpZ25BcGsgZmFpbGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9LiBTdGRvdXQ6ICcke2Uuc3Rkb3V0fSc7IFN0ZGVycjogJyR7ZS5zdGRlcnJ9J2ApO1xuICB9XG59O1xuXG4vKipcbiAqIENoZWNrIGlmIHRoZSBhcHAgaXMgYWxyZWFkeSBzaWduZWQgd2l0aCB0aGUgZGVmYXVsdCBBcHBpdW0gY2VyaXRmaWNhdGUuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGxvY2FsIGFwayBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHBnayAtIFRoZSBuYW1lIG9mIGFwcGxpY2F0aW9uIHBhY2thZ2UuXG4gKiBAcmV0dXJuIHtib29sZWFufSBUcnVlIGlmIGdpdmVuIGFwcGxpY2F0aW9uIGlzIGFscmVhZHkgc2lnbmVkLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0Fwa0NlcnQgPSBhc3luYyBmdW5jdGlvbiAoYXBrLCBwa2cpIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyBhcHAgY2VydCBmb3IgJHthcGt9YCk7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGFwaykpIHtcbiAgICBsb2cuZGVidWcoYCcke2Fwa30nIGRvZXMgbm90IGV4aXN0YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGlmICh0aGlzLnVzZUtleXN0b3JlKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuY2hlY2tDdXN0b21BcGtDZXJ0KGFwaywgcGtnKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgZ2V0QXBrc2lnbmVyRm9yT3ModGhpcyk7XG4gICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgdGhpcy5leGVjdXRlQXBrc2lnbmVyKFsndmVyaWZ5JywgJy0tcHJpbnQtY2VydHMnLCBhcGtdKTtcbiAgICBpZiAoIV8uaW5jbHVkZXMob3V0cHV0LCBERUZBVUxUX0NFUlRfRElHRVNUKSkge1xuICAgICAgbG9nLmRlYnVnKGAnJHthcGt9JyBpcyBzaWduZWQgd2l0aCBub24tZGVmYXVsdCBjZXJ0aWZpY2F0ZWApO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYCcke2Fwa30nIGlzIGFscmVhZHkgc2lnbmVkLmApO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBjaGVjayBpZiB0aGVyZSBpcyBubyBzaWduYXR1cmVcbiAgICBpZiAoZXJyLnN0ZGVyciAmJiBlcnIuc3RkZXJyLmluY2x1ZGVzKEFQS1NJR05FUl9WRVJJRllfRkFJTCkpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgJyR7YXBrfScgaXMgbm90IHNpZ25lZCB3aXRoIGRlYnVnIGNlcnRgKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgbG9nLndhcm4oYENhbm5vdCB1c2UgYXBrc2lnbmVyIHRvb2wgZm9yIHNpZ25hdHVyZSB2ZXJpZmljYXRpb24uIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG5cbiAgLy8gZGVmYXVsdCB0byB2ZXJpZnkuamFyXG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBEZWZhdWx0aW5nIHRvIHZlcmlmeS5qYXJgKTtcbiAgICBjb25zdCBqYXZhID0gZ2V0SmF2YUZvck9zKCk7XG4gICAgYXdhaXQgZXhlYyhqYXZhLCBbJy1qYXInLCBwYXRoLnJlc29sdmUodGhpcy5oZWxwZXJKYXJQYXRoLCAndmVyaWZ5LmphcicpLCBhcGtdKTtcbiAgICBsb2cuZGVidWcoYCcke2Fwa30nIGlzIGFscmVhZHkgc2lnbmVkLmApO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYCcke2Fwa30nIGlzIG5vdCBzaWduZWQgd2l0aCBkZWJ1ZyBjZXJ0JHtlcnIuc3RkZXJyID8gYDogJHtlcnIuc3RkZXJyfWAgOiAnJ31gKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn07XG5cbi8qKlxuICogQ2hlY2sgaWYgdGhlIGFwcCBpcyBhbHJlYWR5IHNpZ25lZCB3aXRoIGEgY3VzdG9tIGNlcnRpZmljYXRlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcGsgLSBUaGUgZnVsbCBwYXRoIHRvIHRoZSBsb2NhbCBhcGsgZmlsZS5cbiAqIEBwYXJhbSB7c3RyaW5nfSBwZ2sgLSBUaGUgbmFtZSBvZiBhcHBsaWNhdGlvbiBwYWNrYWdlLlxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBnaXZlbiBhcHBsaWNhdGlvbiBpcyBhbHJlYWR5IHNpZ25lZCB3aXRoIGEgY3VzdG9tIGNlcnRpZmljYXRlLlxuICovXG5hcGtTaWduaW5nTWV0aG9kcy5jaGVja0N1c3RvbUFwa0NlcnQgPSBhc3luYyBmdW5jdGlvbiAoYXBrLCBwa2cpIHtcbiAgbG9nLmRlYnVnKGBDaGVja2luZyBjdXN0b20gYXBwIGNlcnQgZm9yICR7YXBrfWApO1xuICBsZXQgaCA9IFwiYS1mQS1GMC05XCI7XG4gIGxldCBtZDVTdHIgPSBbYC4qTUQ1LiooKD86WyR7aH1dezJ9Oil7MTV9WyR7aH1dezJ9KWBdO1xuICBsZXQgbWQ1ID0gbmV3IFJlZ0V4cChtZDVTdHIsICdtaScpO1xuICBsZXQgamF2YUhvbWUgPSBnZXRKYXZhSG9tZSgpO1xuICBsZXQga2V5dG9vbCA9IHBhdGgucmVzb2x2ZShqYXZhSG9tZSwgJ2JpbicsIGBrZXl0b29sJHtzeXN0ZW0uaXNXaW5kb3dzKCkgPyAnLmV4ZScgOiAnJ31gKTtcbiAgbGV0IGtleXN0b3JlSGFzaCA9IGF3YWl0IHRoaXMuZ2V0S2V5c3RvcmVNZDUoa2V5dG9vbCwgbWQ1KTtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuY2hlY2tBcGtLZXlzdG9yZU1hdGNoKGtleXRvb2wsIG1kNSwga2V5c3RvcmVIYXNoLCBwa2csIGFwayk7XG59O1xuXG4vKipcbiAqIEdldCB0aGUgTUQ1IGhhc2ggb2YgdGhlIGtleXN0b3JlLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBrZXl0b29sIC0gVGhlIG5hbWUgb2YgdGhlIGtleXRvb2wgdXRpbGl0eS5cbiAqIEBwYXJhbSB7UmVnRXhwfSBtZDVyZSAtIFRoZSBwYXR0ZXJuIHVzZWQgdG8gbWF0Y2ggdGhlIHJlc3VsdCBpbiBfa2V5dG9vbF8gb3V0cHV0LlxuICogQHJldHVybiB7P3N0cmluZ30gS2V5c3RvcmUgTUQ1IGhhc2ggb3IgX251bGxfIGlmIHRoZSBoYXNoIGNhbm5vdCBiZSBwYXJzZWQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgZ2V0dGluZyBrZXlzdG9yZSBNRDUgaGFzaCBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuZ2V0S2V5c3RvcmVNZDUgPSBhc3luYyBmdW5jdGlvbiAoa2V5dG9vbCwgbWQ1cmUpIHtcbiAgbG9nLmRlYnVnKFwiUHJpbnRpbmcga2V5c3RvcmUgbWQ1LlwiKTtcbiAgdHJ5IHtcbiAgICBsZXQge3N0ZG91dH0gPSBhd2FpdCBleGVjKGtleXRvb2wsIFsnLXYnLCAnLWxpc3QnLFxuICAgICAgJy1hbGlhcycsIHRoaXMua2V5QWxpYXMsXG4gICAgICAnLWtleXN0b3JlJywgdGhpcy5rZXlzdG9yZVBhdGgsXG4gICAgICAnLXN0b3JlcGFzcycsIHRoaXMua2V5c3RvcmVQYXNzd29yZF0pO1xuICAgIGxldCBrZXlzdG9yZUhhc2ggPSBtZDVyZS5leGVjKHN0ZG91dCk7XG4gICAga2V5c3RvcmVIYXNoID0ga2V5c3RvcmVIYXNoID8ga2V5c3RvcmVIYXNoWzFdIDogbnVsbDtcbiAgICBsb2cuZGVidWcoYEtleXN0b3JlIE1ENTogJHtrZXlzdG9yZUhhc2h9YCk7XG4gICAgcmV0dXJuIGtleXN0b3JlSGFzaDtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgZ2V0S2V5c3RvcmVNZDUgZmFpbGVkLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbn07XG5cbi8qKlxuICogQ2hlY2sgaWYgdGhlIE1ENSBoYXNoIG9mIHRoZSBwYXJ0aWN1bGFyIGFwcGxpY2F0aW9uIG1hdGNoZXMgdG8gdGhlIGdpdmVuIGhhc2guXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGtleXRvb2wgLSBUaGUgbmFtZSBvZiB0aGUga2V5dG9vbCB1dGlsaXR5LlxuICogQHBhcmFtIHtSZWdFeHB9IG1kNXJlIC0gVGhlIHBhdHRlcm4gdXNlZCB0byBtYXRjaCB0aGUgcmVzdWx0IGluIF9rZXl0b29sXyBvdXRwdXQuXG4gKiBAcGFyYW0ge3N0cmluZ30ga2V5c3RvcmVIYXNoIC0gVGhlIGV4cGVjdGVkIGhhc2ggdmFsdWUuXG4gKiBAcGFyYW0ge3N0cmluZ30gcGtnIC0gVGhlIG5hbWUgb2YgdGhlIGluc3RhbGxlZCBwYWNrYWdlLlxuICogQHBhcmFtIHtzdHJpbmd9IGFwayAtIFRoZSBmdWxsIHBhdGggdG8gdGhlIGV4aXN0aW5nIGFwayBmaWxlLlxuICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiBib3RoIGhhc2hlcyBhcmUgZXF1YWwuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgZ2V0dGluZyBrZXlzdG9yZSBNRDUgaGFzaCBmYWlscy5cbiAqL1xuYXBrU2lnbmluZ01ldGhvZHMuY2hlY2tBcGtLZXlzdG9yZU1hdGNoID0gYXN5bmMgZnVuY3Rpb24gKGtleXRvb2wsIG1kNXJlLCBrZXlzdG9yZUhhc2gsIHBrZywgYXBrKSB7XG4gIGxldCBlbnRyeUhhc2ggPSBudWxsO1xuICBsZXQgcnNhID0gL15NRVRBLUlORlxcLy4qXFwuW3JSXVtzU11bYUFdJC87XG4gIGxldCBmb3VuZEtleXN0b3JlTWF0Y2ggPSBmYWxzZTtcblxuICAvL2ZvciAobGV0IGVudHJ5IG9mIGVudHJpZXMpIHtcbiAgYXdhaXQgemlwLnJlYWRFbnRyaWVzKGFwaywgYXN5bmMgKHtlbnRyeSwgZXh0cmFjdEVudHJ5VG99KSA9PiB7XG4gICAgZW50cnkgPSBlbnRyeS5maWxlTmFtZTtcbiAgICBpZiAoIXJzYS50ZXN0KGVudHJ5KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEVudHJ5OiAke2VudHJ5fWApO1xuICAgIGxldCBlbnRyeVBhdGggPSBwYXRoLmpvaW4odGhpcy50bXBEaXIsIHBrZywgJ2NlcnQnKTtcbiAgICBsb2cuZGVidWcoYGVudHJ5UGF0aDogJHtlbnRyeVBhdGh9YCk7XG4gICAgbGV0IGVudHJ5RmlsZSA9IHBhdGguam9pbihlbnRyeVBhdGgsIGVudHJ5KTtcbiAgICBsb2cuZGVidWcoYGVudHJ5RmlsZTogJHtlbnRyeUZpbGV9YCk7XG4gICAgLy8gZW5zdXJlIC90bXAvcGtnL2NlcnQvIGRvZXNuJ3QgZXhpc3Qgb3IgZXh0cmFjdCB3aWxsIGZhaWwuXG4gICAgYXdhaXQgZnMucmltcmFmKGVudHJ5UGF0aCk7XG4gICAgLy8gTUVUQS1JTkYvQ0VSVC5SU0FcbiAgICBhd2FpdCBleHRyYWN0RW50cnlUbyhlbnRyeVBhdGgpO1xuICAgIGxvZy5kZWJ1ZyhcImV4dHJhY3RlZCFcIik7XG4gICAgLy8gY2hlY2sgZm9yIG1hdGNoXG4gICAgbG9nLmRlYnVnKFwiUHJpbnRpbmcgYXBrIG1kNS5cIik7XG4gICAgbGV0IHtzdGRvdXR9ID0gYXdhaXQgZXhlYyhrZXl0b29sLCBbJy12JywgJy1wcmludGNlcnQnLCAnLWZpbGUnLCBlbnRyeUZpbGVdKTtcbiAgICBlbnRyeUhhc2ggPSBtZDVyZS5leGVjKHN0ZG91dCk7XG4gICAgZW50cnlIYXNoID0gZW50cnlIYXNoID8gZW50cnlIYXNoWzFdIDogbnVsbDtcbiAgICBsb2cuZGVidWcoYGVudHJ5SGFzaCBNRDU6ICR7ZW50cnlIYXNofWApO1xuICAgIGxvZy5kZWJ1Zyhga2V5c3RvcmUgTUQ1OiAke2tleXN0b3JlSGFzaH1gKTtcbiAgICBsZXQgbWF0Y2hlc0tleXN0b3JlID0gZW50cnlIYXNoICYmIGVudHJ5SGFzaCA9PT0ga2V5c3RvcmVIYXNoO1xuICAgIGxvZy5kZWJ1ZyhgTWF0Y2hlcyBrZXlzdG9yZT8gJHttYXRjaGVzS2V5c3RvcmV9YCk7XG5cbiAgICAvLyBJZiB3ZSBoYXZlIGEga2V5c3RvcmUgbWF0Y2gsIHN0b3AgaXRlcmF0aW5nXG4gICAgaWYgKG1hdGNoZXNLZXlzdG9yZSkge1xuICAgICAgZm91bmRLZXlzdG9yZU1hdGNoID0gdHJ1ZTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gZm91bmRLZXlzdG9yZU1hdGNoO1xufTtcblxuZXhwb3J0IGRlZmF1bHQgYXBrU2lnbmluZ01ldGhvZHM7XG4iXSwiZmlsZSI6ImxpYi90b29scy9hcGstc2lnbmluZy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
